# Cursor AI Rules for n8n-scraper-docker

## Project Context
This is a Docker-based n8n scraping platform with ML routing.
Always prioritize security and production readiness.

## Code Standards

### Python
- Type hints required for all functions
- Docstrings mandatory (Google style)
- Use async/await for I/O operations
- Error handling for all external API calls
- Logging with context (use loguru)

### JavaScript/TypeScript
- JSDoc comments for complex functions
- Use ES6+ syntax (const/let, arrow functions)
- Async/await over promises
- Error boundaries for all workflows

### Docker
- Multi-stage builds
- Healthchecks mandatory
- Pin versions (no :latest in production)
- Resource limits (CPU/memory)

### Secrets
- Never commit .env files
- Use environment variables
- Add `# @ai-ignore` for sensitive values
- Generate passwords with `openssl rand -base64 24`

## Testing

Run tests before committing:
```bash
pytest tests/unit/ && bash tests/master/test_full_e2e.sh
```

## Documentation

Update when changing:
- Architecture: `.ai/context.md`, `ARCHITECTURE.md`
- API changes: `docs/API.md`
- Security: `SECURITY.md`

## Security

### Critical Checks
- [ ] CVE-2025-62725 status for Docker Compose v2.40.2+
- [ ] Never expose DB ports (5432, 6379) without firewall
- [ ] Add TLS for production (nginx/caddy reverse proxy)
- [ ] Strong passwords (20+ chars) in .env
- [ ] Rotate credentials every 90 days

## Common Commands

```bash
# Start
docker-compose up -d

# Test
bash tests/master/test_full_e2e.sh

# Logs
docker-compose logs -f [service]

# Backup
docker-compose exec postgres pg_dump -U n8n_user n8n_db | gzip > backup.sql.gz
```

## Architecture

8 microservices:
- n8n (5678) - Workflow orchestrator
- postgres (5432) - Database
- redis (6379) - Cache + rate limiter
- tor (9050) - IP rotation
- ml-service (8000) - Smart routing
- ollama (11434) - Local LLM
- prometheus (9090) - Metrics
- grafana (3000) - Dashboards

## Key Files

- `docker-compose.yml` - Main orchestration
- `ml/app.py` - ML routing logic
- `scrapers/*.py` - Scraper implementations
- `.env.example` - Configuration template

## Performance Targets

- Success rate: ≥87%
- Latency: ≤5.3s average
- Cost: ≤$2.88/1000 URLs
- Memory: Stable over 24h

## Anti-Patterns

❌ Don't use `:latest` tags in production
❌ Don't commit .env files
❌ Don't expose DB ports without firewall
❌ Don't skip healthchecks
❌ Don't use `localStorage` in n8n (sandbox CSP)

---

**Read `.ai/context.md` and `.ai/instructions.md` for detailed guidelines**
