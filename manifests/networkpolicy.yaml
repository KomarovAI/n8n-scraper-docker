apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: n8n-scraper
  namespace: n8n-scraper
spec:
  podSelector:
    matchLabels:
      app: n8n-scraper
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # Разрешить трафик от Traefik
    - from:
        - namespaceSelector:
            matchLabels:
              name: traefik
      ports:
        - protocol: TCP
          port: 5678
    
    # Разрешить подам в namespace общаться между собой
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 5678
  
  egress:
    # DNS resolution (kube-dns/coredns)
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # PostgreSQL (в том же namespace)
    - to:
        - podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432
    
    # Redis (в том же namespace)
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    
    # HTTPS/HTTP к Internet для scraping
    # Используем CIDR вместо namespaceSelector: {}
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              # Исключаем локальные сети
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
              # Cloud metadata endpoints
              - 169.254.169.254/32  # AWS, Azure, GCP
              - 100.100.100.200/32  # Alibaba Cloud
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql
  namespace: n8n-scraper
spec:
  podSelector:
    matchLabels:
      app: postgresql
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # Разрешить только от N8N
    - from:
        - podSelector:
            matchLabels:
              app: n8n-scraper
      ports:
        - protocol: TCP
          port: 5432
  
  egress:
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis
  namespace: n8n-scraper
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # Разрешить только от N8N
    - from:
        - podSelector:
            matchLabels:
              app: n8n-scraper
      ports:
        - protocol: TCP
          port: 6379
  
  egress:
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
