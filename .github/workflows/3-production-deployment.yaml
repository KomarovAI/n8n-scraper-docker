name: 3 Production Deployment

on:
  # üéØ –ó–ê–ü–£–°–ö –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ì–û WORKFLOW 2
  workflow_run:
    workflows: ["2 n8n Validation (Self-Hosted)"]
    types: [completed]
    branches: [main]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip health checks after deployment'
        required: false
        type: boolean
        default: false

concurrency:
  group: production-deployment
  cancel-in-progress: false  # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –¥–µ–ø–ª–æ–π!

env:
  DEPLOY_DIR: /home/artikk/n8n-production
  BACKUP_DIR: /home/artikk/n8n-backups
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–µ–ø–ª–æ—è
  check-deployment-conditions:
    name: Check Deployment Conditions
    runs-on: self-hosted
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      validation_status: ${{ steps.check.outputs.validation_status }}
    steps:
      - name: üîç Check workflow trigger
        id: check
        run: |
          echo "Trigger: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          
          # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ - –≤—Å–µ–≥–¥–∞ –¥–µ–ø–ª–æ–∏–º
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "validation_status=manual" >> $GITHUB_OUTPUT
            echo "‚úÖ Manual deployment triggered"
            exit 0
          fi
          
          # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "validation_status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Validation passed, proceeding with deployment"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "validation_status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå Validation failed, skipping deployment"
          fi

  # –ë—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
  backup-current-deployment:
    name: Backup Current Deployment
    runs-on: self-hosted
    needs: check-deployment-conditions
    if: needs.check-deployment-conditions.outputs.should_deploy == 'true'
    steps:
      - name: üíæ Create backup
        run: |
          echo "üíæ Creating backup of current deployment..."
          
          # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±—ç–∫–∞–ø–æ–≤
          mkdir -p ${{ env.BACKUP_DIR }}
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_NAME="n8n-backup-${TIMESTAMP}"
          
          # –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          if docker ps | grep -q postgres; then
            echo "üì¶ Backing up PostgreSQL database..."
            docker exec postgres pg_dump -U n8n n8n > "${{ env.BACKUP_DIR }}/${BACKUP_NAME}.sql"
            gzip "${{ env.BACKUP_DIR }}/${BACKUP_NAME}.sql"
            echo "‚úÖ Database backup created: ${BACKUP_NAME}.sql.gz"
          else
            echo "‚ö†Ô∏è  PostgreSQL container not running, skipping DB backup"
          fi
          
          # –ë—ç–∫–∞–ø .env —Ñ–∞–π–ª–∞
          if [ -f "${{ env.DEPLOY_DIR }}/.env" ]; then
            cp "${{ env.DEPLOY_DIR }}/.env" "${{ env.BACKUP_DIR }}/${BACKUP_NAME}.env"
            echo "‚úÖ .env file backed up"
          fi
          
          # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
          cd ${{ env.BACKUP_DIR }}
          ls -t n8n-backup-*.sql.gz 2>/dev/null | tail -n +6 | xargs -r rm
          echo "üßπ Old backups cleaned up (keeping last 5)"
          
          echo "‚úÖ Backup completed: ${BACKUP_NAME}"

  # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ production
  deploy-to-production:
    name: Deploy to Production
    runs-on: self-hosted
    needs: [check-deployment-conditions, backup-current-deployment]
    if: needs.check-deployment-conditions.outputs.should_deploy == 'true'
    timeout-minutes: 20
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v6
      
      - name: üìù Prepare production directory
        run: |
          echo "üìã Preparing production directory..."
          
          # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          mkdir -p ${{ env.DEPLOY_DIR }}
          
          # –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã
          rsync -av --delete \
            --exclude='.git' \
            --exclude='_work' \
            --exclude='node_modules' \
            --exclude='.env' \
            ./ ${{ env.DEPLOY_DIR }}/
          
          echo "‚úÖ Code synced to production directory"
      
      - name: üîë Create production .env
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "üîë Creating production .env file..."
          
          cat > .env << EOF
          # Production Environment Variables
          # Generated: $(date)
          
          # Database
          POSTGRES_DB=n8n
          POSTGRES_USER=n8n
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          
          # Redis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          
          # n8n Configuration
          N8N_HOST=0.0.0.0
          N8N_PORT=5678
          N8N_PROTOCOL=http
          WEBHOOK_URL=http://192.168.0.105:5678/
          
          # n8n Authentication
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          N8N_API_KEY=${{ secrets.N8N_API_KEY }}
          
          # Tor
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          
          # Monitoring
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          
          # Optional API Keys
          FIRECRAWL_API_KEY=
          JINA_API_KEY=
          EOF
          
          chmod 600 .env
          echo "‚úÖ Production .env created"
      
      - name: üè≠ Build production images
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "üè≠ Building production Docker images..."
          
          docker build \
            -t n8n-enhanced:production \
            -t n8n-enhanced:latest \
            -f Dockerfile.n8n-enhanced \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            .
          
          echo "‚úÖ Images built successfully"
      
      - name: üõë Stop current services (graceful)
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "üõë Stopping current services..."
          
          if [ -f docker-compose.yml ]; then
            # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å n8n (–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –±–∞–∑—É)
            docker compose stop n8n tor 2>/dev/null || true
            
            # –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            sleep 5
            
            echo "‚úÖ Services stopped gracefully"
          else
            echo "‚ö†Ô∏è  No docker-compose.yml found, skipping stop"
          fi
      
      - name: üöÄ Start production services
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "üöÄ Starting production services..."
          
          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–∞–∑—É –∏ Redis (–µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã)
          docker compose up -d postgres redis
          
          # –ü–æ–¥–æ–∂–¥–∞—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –±–∞–∑—ã
          echo "‚è≥ Waiting for database..."
          sleep 15
          
          # –ó–∞–ø—É—Å—Ç–∏—Ç—å n8n —Å –Ω–æ–≤—ã–º –æ–±—Ä–∞–∑–æ–º
          docker compose up -d n8n tor
          
          echo "‚úÖ Services started"
      
      - name: ‚è≥ Wait for n8n startup
        run: |
          echo "‚è≥ Waiting for n8n to become healthy..."
          
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
              echo "‚úÖ n8n is healthy!"
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            sleep 2
          done
          
          echo "‚ùå n8n failed to start within timeout"
          docker compose -f ${{ env.DEPLOY_DIR }}/docker-compose.yml logs n8n
          exit 1
      
      - name: üìä Deploy monitoring stack
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "üìä Starting monitoring services..."
          
          docker compose up -d prometheus grafana
          
          echo "‚úÖ Monitoring stack deployed"
        continue-on-error: true
      
      - name: üß™ Post-deployment health check
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "üß™ Running post-deployment health checks..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
          CHECKS_PASSED=0
          CHECKS_FAILED=0
          
          # 1. n8n health
          if curl -sf http://localhost:5678/healthz; then
            echo "‚úÖ n8n health check passed"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "‚ùå n8n health check failed"
            CHECKS_FAILED=$((CHECKS_FAILED + 1))
          fi
          
          # 2. Database connection
          if docker exec postgres pg_isready -U n8n; then
            echo "‚úÖ Database connection check passed"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "‚ùå Database connection check failed"
            CHECKS_FAILED=$((CHECKS_FAILED + 1))
          fi
          
          # 3. Redis connection
          if docker exec redis redis-cli ping | grep -q PONG; then
            echo "‚úÖ Redis connection check passed"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "‚ùå Redis connection check failed"
            CHECKS_FAILED=$((CHECKS_FAILED + 1))
          fi
          
          echo ""
          echo "====================================="
          echo "üìä Health Check Summary"
          echo "====================================="
          echo "Passed: $CHECKS_PASSED"
          echo "Failed: $CHECKS_FAILED"
          
          if [ $CHECKS_FAILED -gt 0 ]; then
            echo "‚ùå Some health checks failed!"
            exit 1
          fi
          
          echo "‚úÖ All health checks passed!"
      
      - name: üìã Display deployment info
        if: success()
        run: |
          echo ""
          echo "====================================="
          echo "üéâ DEPLOYMENT SUCCESSFUL"
          echo "====================================="
          echo ""
          echo "Deployment Details:"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Branch: ${{ github.ref }}"
          echo "  - Deploy Time: $(date)"
          echo "  - Deployed By: ${{ github.actor }}"
          echo ""
          echo "Services:"
          docker compose -f ${{ env.DEPLOY_DIR }}/docker-compose.yml ps
          echo ""
          echo "Access URLs:"
          echo "  - n8n: http://192.168.0.105:5678"
          echo "  - Grafana: http://192.168.0.105:3001"
          echo "  - Prometheus: http://192.168.0.105:9090"
          echo ""
      
      - name: üö® Rollback on failure
        if: failure()
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "üö® Deployment failed! Attempting rollback..."
          
          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª–æ–º–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
          docker compose down n8n tor
          
          # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–∑ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          if docker images | grep -q n8n-enhanced; then
            echo "Rolling back to previous image..."
            # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –æ–±—Ä–∞–∑–æ–º
            docker compose up -d n8n tor
          fi
          
          echo "‚ùå Rollback completed. Check logs for details."
          docker compose logs --tail=100 n8n

  # –ù–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
  deployment-notification:
    name: Deployment Notification
    runs-on: self-hosted
    needs: [check-deployment-conditions, deploy-to-production]
    if: always() && needs.check-deployment-conditions.outputs.should_deploy == 'true'
    steps:
      - name: üì£ Summary
        run: |
          echo ""
          echo "====================================="
          echo "üì£ DEPLOYMENT SUMMARY"
          echo "====================================="
          echo ""
          echo "Status: ${{ needs.deploy-to-production.result }}"
          echo "Validation: ${{ needs.check-deployment-conditions.outputs.validation_status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Time: $(date)"
          echo ""
          
          if [ "${{ needs.deploy-to-production.result }}" = "success" ]; then
            echo "‚úÖ Deployment completed successfully!"
            echo ""
            echo "Next steps:"
            echo "  1. Verify n8n: http://192.168.0.105:5678"
            echo "  2. Check metrics: http://192.168.0.105:3001"
            echo "  3. Monitor logs: docker compose logs -f n8n"
          else
            echo "‚ùå Deployment failed!"
            echo ""
            echo "Troubleshooting:"
            echo "  1. Check runner logs: journalctl -u actions.runner.*"
            echo "  2. Check n8n logs: docker compose logs n8n"
            echo "  3. Verify backup: ls -lh ${{ env.BACKUP_DIR }}"
          fi
