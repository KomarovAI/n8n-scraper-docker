name: Deploy to Cluster (Single-Node)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ð¦ÐµÐ»ÐµÐ²Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - dev

# Ð”Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ concurrency control - Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¸
concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false  # ÐÐµ Ð¾Ñ‚Ð¼ÐµÐ½ÑÑ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹

permissions:
  contents: read

jobs:
  # Job 1: Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker-Ð¾Ð±Ñ€Ð°Ð·Ð° (Runner #1)
  build-n8n-image:
    name: ðŸ“¦ Build N8N Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        if: github.event.inputs.environment == 'production'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta (tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/n8n-scraper
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event.inputs.environment == 'production' }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENVIRONMENT=${{ github.event.inputs.environment }}

  # Job 2: Ð Ð°ÑÐºÐ°Ñ‚ÐºÐ° Ð² ÐºÐ»Ð°ÑÑ‚ÐµÑ€ (Runner #2)
  rollout-to-cluster:
    name: ðŸš€ Deploy to K8s (${{ github.event.inputs.environment }})
    needs: build-n8n-image
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl cluster-info

      - name: Replace SERVER_IP in manifests
        run: |
          sed -i "s/YOUR_SERVER_IP/${{ secrets.SERVER_IP }}/g" manifests/ingressroute.yaml

      - name: Apply manifests (in order)
        run: |
          echo "âž¡ï¸  Creating namespace..."
          kubectl apply -f manifests/namespace.yaml
          
          echo "âž¡ï¸  Creating StorageClass..."
          kubectl apply -f manifests/storageclass.yaml
          
          echo "âž¡ï¸  Creating secrets..."
          kubectl apply -f manifests/secret.yaml || echo "Secrets already exist"
          
          echo "âž¡ï¸  Deploying PostgreSQL..."
          kubectl apply -f manifests/postgresql.yaml
          
          echo "âž¡ï¸  Deploying Redis..."
          kubectl apply -f manifests/redis.yaml
          
          echo "âž¡ï¸  Waiting for databases..."
          kubectl wait --for=condition=ready pod -l app=postgresql -n n8n-scraper --timeout=120s || true
          kubectl wait --for=condition=ready pod -l app=redis -n n8n-scraper --timeout=60s || true
          
          echo "âž¡ï¸  Deploying N8N..."
          kubectl apply -f manifests/statefulset.yaml
          
          echo "âž¡ï¸  Creating services..."
          kubectl apply -f manifests/service.yaml
          
          echo "âž¡ï¸  Applying NetworkPolicy..."
          kubectl apply -f manifests/networkpolicy.yaml
          
          echo "âž¡ï¸  Creating IngressRoute..."
          kubectl apply -f manifests/ingressroute.yaml

      - name: Wait for N8N rollout
        run: |
          kubectl rollout status statefulset/n8n-scraper -n n8n-scraper --timeout=300s

      - name: Print deployment status
        if: always()
        run: |
          echo "### ðŸ“Š Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Pods:" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n n8n-scraper >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Services:" >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n n8n-scraper >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### PVCs:" >> $GITHUB_STEP_SUMMARY
          kubectl get pvc -n n8n-scraper >> $GITHUB_STEP_SUMMARY || true
