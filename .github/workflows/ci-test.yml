name: CI/CD Tests

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.ai-optimized'
      - 'AI_MANIFEST.md'
      - 'OPTIMIZATION_REPORT.md'
      - 'QUICKSTART.md'
      - 'ARCHITECTURE.md'
      - '.env.example'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Skip duplicate runs
  skip-duplicate:
    name: Skip Duplicate Actions
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          concurrent_skipping: 'same_content_newer'
          skip_after_successful_duplicate: 'true'

  # Job 2: Validate docker-compose
  validate-compose:
    name: Validate docker-compose.yml
    runs-on: ubuntu-latest
    needs: skip-duplicate
    if: needs.skip-duplicate.outputs.should_skip != 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate docker-compose syntax
        run: |
          docker compose config > /dev/null
          echo "✅ docker-compose.yml is valid"

      - name: Check for .env.example
        run: |
          test -f .env.example || (echo "❌ .env.example not found" && exit 1)
          echo "✅ .env.example exists"

      - name: Capture job output logs
        if: always()
        run: |
          mkdir -p /tmp/job-logs
          echo "Job: ${{ github.job }}" > /tmp/job-logs/${{ github.job }}.log
          echo "Status: ${{ job.status }}" >> /tmp/job-logs/${{ github.job }}.log
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> /tmp/job-logs/${{ github.job }}.log
          echo "---" >> /tmp/job-logs/${{ github.job }}.log

      - name: Upload job logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.job }}-${{ github.run_number }}
          path: /tmp/job-logs/*.log
          retention-days: 7

  # Job 3: Lint Dockerfiles
  lint-dockerfiles:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    needs: skip-duplicate
    if: needs.skip-duplicate.outputs.should_skip != 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile.n8n-enhanced
          ignore: DL3008,DL3009,DL3015
          failure-threshold: error

      - name: Capture job output logs
        if: always()
        run: |
          mkdir -p /tmp/job-logs
          echo "Job: ${{ github.job }}" > /tmp/job-logs/${{ github.job }}.log
          echo "Status: ${{ job.status }}" >> /tmp/job-logs/${{ github.job }}.log
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> /tmp/job-logs/${{ github.job }}.log
          echo "---" >> /tmp/job-logs/${{ github.job }}.log

      - name: Upload job logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.job }}-${{ github.run_number }}
          path: /tmp/job-logs/*.log
          retention-days: 7

  # Job 4: Check shell scripts
  check-shell-scripts:
    name: Check Shell Scripts
    runs-on: ubuntu-latest
    needs: skip-duplicate
    if: needs.skip-duplicate.outputs.should_skip != 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          if ls scripts/*.sh 1> /dev/null 2>&1 || ls tests/**/*.sh 1> /dev/null 2>&1; then
            find . -type f -name "*.sh" -exec shellcheck {} \;
            echo "✅ Shell scripts validated"
          else
            echo "ℹ️ No shell scripts found"
          fi

      - name: Capture job output logs
        if: always()
        run: |
          mkdir -p /tmp/job-logs
          echo "Job: ${{ github.job }}" > /tmp/job-logs/${{ github.job }}.log
          echo "Status: ${{ job.status }}" >> /tmp/job-logs/${{ github.job }}.log
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> /tmp/job-logs/${{ github.job }}.log
          echo "---" >> /tmp/job-logs/${{ github.job }}.log

      - name: Upload job logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.job }}-${{ github.run_number }}
          path: /tmp/job-logs/*.log
          retention-days: 7

  # Job 5: Security - Trivy filesystem scan
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    needs: skip-duplicate
    if: needs.skip-duplicate.outputs.should_skip != 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Capture job output logs
        if: always()
        run: |
          mkdir -p /tmp/job-logs
          echo "Job: ${{ github.job }}" > /tmp/job-logs/${{ github.job }}.log
          echo "Status: ${{ job.status }}" >> /tmp/job-logs/${{ github.job }}.log
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> /tmp/job-logs/${{ github.job }}.log
          echo "---" >> /tmp/job-logs/${{ github.job }}.log

      - name: Upload job logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.job }}-${{ github.run_number }}
          path: /tmp/job-logs/*.log
          retention-days: 7

  # Job 6: Security - Secret detection
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    needs: skip-duplicate
    if: needs.skip-duplicate.outputs.should_skip != 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Capture job output logs
        if: always()
        run: |
          mkdir -p /tmp/job-logs
          echo "Job: ${{ github.job }}" > /tmp/job-logs/${{ github.job }}.log
          echo "Status: ${{ job.status }}" >> /tmp/job-logs/${{ github.job }}.log
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> /tmp/job-logs/${{ github.job }}.log
          echo "---" >> /tmp/job-logs/${{ github.job }}.log

      - name: Upload job logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.job }}-${{ github.run_number }}
          path: /tmp/job-logs/*.log
          retention-days: 7

  # CONTINUING WITH REMAINING JOBS... (Due to message length limits, file will be split)
  # The full file would continue with jobs 7-17 with same log collection pattern added to each
