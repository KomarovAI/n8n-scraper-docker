name: CI/CD Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Job 1: Validate docker-compose (Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹)
  validate-compose:
    name: Validate docker-compose.yml
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate docker-compose syntax
        run: |
          docker compose config > /dev/null
          echo "âœ… docker-compose.yml is valid"

      - name: Check for .env.example
        run: |
          test -f .env.example || (echo "âŒ .env.example not found" && exit 1)
          echo "âœ… .env.example exists"

  # Job 2: Lint Dockerfiles (Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹)
  lint-dockerfiles:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile.n8n-enhanced
          ignore: DL3008,DL3009,DL3015
          failure-threshold: error

  # Job 3: Check shell scripts (Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹)
  check-shell-scripts:
    name: Check Shell Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          if ls scripts/*.sh 1> /dev/null 2>&1; then
            find . -type f -name "*.sh" -exec shellcheck {} \;
            echo "âœ… Shell scripts validated"
          else
            echo "â„¹ï¸ No shell scripts found"
          fi

  # Job 4: Security - Trivy filesystem scan (ÑÑ€ÐµÐ´Ð½Ð¸Ð¹, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹)
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Job 5: Security - Secret detection (ÑÑ€ÐµÐ´Ð½Ð¸Ð¹, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹)
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # Job 6: Build n8n-enhanced image (Ð´Ð¾Ð»Ð³Ð¸Ð¹, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹)
  build-n8n:
    name: Build n8n-enhanced
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build n8n-enhanced image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.n8n-enhanced
          tags: n8n-scraper:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test image size
        run: |
          SIZE=$(docker images n8n-scraper:test --format "{{.Size}}")
          echo "ðŸ“¦ Image size: $SIZE"

      - name: Inspect image layers
        run: docker history n8n-scraper:test --human

  # Job 7: Build ML Service image (Ð´Ð¾Ð»Ð³Ð¸Ð¹, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹)
  build-ml-service:
    name: Build ML Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check if ML Dockerfile exists
        id: check-ml
        run: |
          if [ -f "ml/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build ML Service image
        if: steps.check-ml.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./ml
          file: ./ml/Dockerfile
          tags: ml-service:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 8: Health checks (ÑÑ€ÐµÐ´Ð½Ð¸Ð¹, Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ lint)
  health-check:
    name: Health Check Tests
    runs-on: ubuntu-latest
    needs: [validate-compose]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_DB=scraper_db
          POSTGRES_USER=scraper_user
          POSTGRES_PASSWORD=test_password_12345678901234567890
          REDIS_PASSWORD=test_redis_password_1234567890123456
          N8N_USER=admin
          N8N_PASSWORD=test_n8n_password_12345678901234567890
          TOR_CONTROL_PASSWORD=test_tor_password_1234567890123456
          GRAFANA_USER=admin
          GRAFANA_PASSWORD=test_grafana_password_12345678901234
          HUGGINGFACE_TOKEN=
          GRAFANA_ROOT_URL=http://localhost:3000
          EOF

      - name: Start core services
        run: |
          docker compose up -d postgres redis prometheus grafana node-exporter redis-exporter postgres-exporter
          echo "â³ Waiting for services to be healthy..."

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if docker compose exec -T postgres pg_isready -U scraper_user 2>/dev/null; then
              echo "âœ… PostgreSQL is healthy"
              exit 0
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done
          exit 1

      - name: Wait for Redis
        run: |
          for i in {1..30}; do
            if docker compose exec -T redis redis-cli --no-auth-warning -a test_redis_password_1234567890123456 ping 2>/dev/null | grep -q PONG; then
              echo "âœ… Redis is healthy"
              exit 0
            fi
            echo "Waiting for Redis... ($i/30)"
            sleep 2
          done
          exit 1

      - name: Wait for Prometheus
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:9090/-/healthy 2>/dev/null; then
              echo "âœ… Prometheus is healthy"
              exit 0
            fi
            echo "Waiting for Prometheus... ($i/30)"
            sleep 2
          done
          exit 1

      - name: Wait for Grafana
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/health 2>/dev/null; then
              echo "âœ… Grafana is healthy"
              exit 0
            fi
            echo "Waiting for Grafana... ($i/30)"
            sleep 2
          done
          exit 1

      - name: Check exporters
        run: |
          curl -f http://localhost:9100/metrics > /dev/null
          echo "âœ… Node Exporter responding"
          
          curl -f http://localhost:9121/metrics > /dev/null
          echo "âœ… Redis Exporter responding"
          
          curl -f http://localhost:9187/metrics > /dev/null
          echo "âœ… PostgreSQL Exporter responding"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Status ==="
          docker compose ps
          echo ""
          echo "=== All Logs ==="
          docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # Job 9: Integration tests (Ð´Ð¾Ð»Ð³Ð¸Ð¹, Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ lint Ð¸ build)
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [validate-compose, lint-dockerfiles]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_DB=scraper_db
          POSTGRES_USER=scraper_user
          POSTGRES_PASSWORD=test_password_12345678901234567890
          REDIS_PASSWORD=test_redis_password_1234567890123456
          N8N_USER=admin
          N8N_PASSWORD=test_n8n_password_12345678901234567890
          TOR_CONTROL_PASSWORD=test_tor_password_1234567890123456
          GRAFANA_USER=admin
          GRAFANA_PASSWORD=test_grafana_password_12345678901234
          HUGGINGFACE_TOKEN=
          GRAFANA_ROOT_URL=http://localhost:3000
          EOF

      - name: Start full stack
        run: |
          docker compose up -d postgres redis tor prometheus grafana node-exporter redis-exporter postgres-exporter
          echo "â³ Waiting for services to be ready..."
          sleep 60

      - name: Test PostgreSQL connectivity
        run: |
          docker compose exec -T postgres psql -U scraper_user -d scraper_db -c "SELECT version();" > /dev/null
          echo "âœ… PostgreSQL connectivity test passed"

      - name: Test Redis read/write
        run: |
          docker compose exec -T redis redis-cli --no-auth-warning -a test_redis_password_1234567890123456 SET test_key "test_value"
          RESULT=$(docker compose exec -T redis redis-cli --no-auth-warning -a test_redis_password_1234567890123456 GET test_key)
          if [ "$RESULT" = "test_value" ]; then
            echo "âœ… Redis read/write test passed"
          else
            echo "âŒ Redis test failed"
            exit 1
          fi

      - name: Test data persistence
        run: |
          echo "ðŸ§ª Testing data persistence..."
          
          # Write data
          docker compose exec -T postgres psql -U scraper_user -d scraper_db -c "CREATE TABLE test_table (id INT, data TEXT);"
          docker compose exec -T postgres psql -U scraper_user -d scraper_db -c "INSERT INTO test_table VALUES (1, 'test_data');"
          
          # Restart
          docker compose restart postgres
          sleep 15
          
          # Verify data persisted
          docker compose exec -T postgres psql -U scraper_user -d scraper_db -c "SELECT * FROM test_table;" | grep "test_data"
          echo "âœ… Data persistence verified"

      - name: Test Prometheus targets
        run: |
          TARGETS=$(curl -s http://localhost:9090/api/v1/targets | jq -r '.data.activeTargets[] | select(.health=="up") | .scrapeUrl')
          COUNT=$(echo "$TARGETS" | wc -l)
          echo "âœ… Prometheus has $COUNT healthy targets:"
          echo "$TARGETS"

      - name: Test all exporters
        run: |
          echo "Testing exporters..."
          
          curl -f http://localhost:9100/metrics | grep -q "node_cpu_seconds_total"
          echo "âœ… Node Exporter: CPU metrics available"
          
          curl -f http://localhost:9121/metrics | grep -q "redis_memory_used_bytes"
          echo "âœ… Redis Exporter: Memory metrics available"
          
          curl -f http://localhost:9187/metrics | grep -q "pg_stat_database_numbackends"
          echo "âœ… PostgreSQL Exporter: Connection metrics available"

      - name: Test Grafana API
        run: |
          # Test health endpoint
          curl -f http://localhost:3000/api/health
          echo "âœ… Grafana health OK"
          
          # Test datasources
          curl -u admin:test_grafana_password_12345678901234 http://localhost:3000/api/datasources | jq
          echo "âœ… Grafana API responding"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Status ==="
          docker compose ps
          echo ""
          echo "=== Failed Service Logs ==="
          docker compose logs --tail=100

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # Job 10: Test Tor connectivity (ÑÑ€ÐµÐ´Ð½Ð¸Ð¹, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹)
  test-tor:
    name: Test Tor Proxy
    runs-on: ubuntu-latest
    needs: [validate-compose]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          TOR_CONTROL_PASSWORD=test_tor_password_1234567890123456
          EOF

      - name: Start Tor
        run: |
          docker compose up -d tor
          echo "â³ Waiting for Tor to initialize..."
          sleep 30

      - name: Test Tor SOCKS proxy
        run: |
          # Install curl with SOCKS support
          sudo apt-get update && sudo apt-get install -y curl
          
          # Test Tor connection
          for i in {1..10}; do
            if curl --socks5 localhost:9050 --socks5-hostname localhost:9050 -s https://check.torproject.org/api/ip | jq -r '.IsTor' | grep -q true; then
              echo "âœ… Tor proxy is working"
              exit 0
            fi
            echo "Waiting for Tor... ($i/10)"
            sleep 10
          done
          echo "âŒ Tor test failed"
          exit 1

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # Job 11: Test matrix Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹ (Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ð¹)
  test-configurations:
    name: Test Config (${{ matrix.config }})
    runs-on: ubuntu-latest
    needs: [validate-compose]
    strategy:
      fail-fast: false
      matrix:
        config:
          - minimal  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
          - monitoring  # Ð¡ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð¾Ð¼
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_DB=scraper_db
          POSTGRES_USER=scraper_user
          POSTGRES_PASSWORD=test_password_12345678901234567890
          REDIS_PASSWORD=test_redis_password_1234567890123456
          N8N_USER=admin
          N8N_PASSWORD=test_n8n_password_12345678901234567890
          TOR_CONTROL_PASSWORD=test_tor_password_1234567890123456
          GRAFANA_USER=admin
          GRAFANA_PASSWORD=test_grafana_password_12345678901234
          HUGGINGFACE_TOKEN=
          GRAFANA_ROOT_URL=http://localhost:3000
          EOF

      - name: Start services (minimal config)
        if: matrix.config == 'minimal'
        run: |
          docker compose up -d postgres redis
          sleep 20
          docker compose ps
          echo "âœ… Minimal config started"

      - name: Start services (monitoring config)
        if: matrix.config == 'monitoring'
        run: |
          docker compose up -d postgres redis prometheus grafana node-exporter redis-exporter postgres-exporter
          sleep 40
          docker compose ps
          echo "âœ… Monitoring config started"

      - name: Verify services running
        run: |
          RUNNING=$(docker compose ps --services --filter "status=running" | wc -l)
          echo "âœ… $RUNNING services running"
          if [ "$RUNNING" -lt 2 ]; then
            echo "âŒ Not enough services running"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # Job 12: Final summary (Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð²ÑÐµÑ…)
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: 
      - validate-compose
      - lint-dockerfiles
      - check-shell-scripts
      - trivy-scan
      - secret-scan
      - build-n8n
      - build-ml-service
      - health-check
      - test-tor
      - integration-test
      - test-configurations
    if: always()
    
    steps:
      - name: Check all test results
        run: |
          echo "ðŸŽ‰ All CI/CD tests completed!"
          echo ""
          echo "ðŸ“Š Test Results:"
          echo "  âœ… Docker Compose Validation"
          echo "  âœ… Dockerfile Linting"
          echo "  âœ… Shell Script Checks"
          echo "  âœ… Trivy Security Scan"
          echo "  âœ… Secret Detection"
          echo "  âœ… n8n-enhanced Build"
          echo "  âœ… ML Service Build"
          echo "  âœ… Health Checks"
          echo "  âœ… Tor Connectivity"
          echo "  âœ… Integration Tests"
          echo "  âœ… Configuration Tests"
          echo ""
          echo "ðŸš€ Ready for deployment!"

      - name: Report status
        run: |
          if [ "${{ needs.validate-compose.result }}" = "success" ] && \
             [ "${{ needs.lint-dockerfiles.result }}" = "success" ] && \
             [ "${{ needs.check-shell-scripts.result }}" = "success" ] && \
             [ "${{ needs.trivy-scan.result }}" = "success" ] && \
             [ "${{ needs.secret-scan.result }}" = "success" ] && \
             [ "${{ needs.build-n8n.result }}" = "success" ] && \
             [ "${{ needs.health-check.result }}" = "success" ] && \
             [ "${{ needs.integration-test.result }}" = "success" ]; then
            echo "âœ… ALL TESTS PASSED - PRODUCTION READY"
          else
            echo "âŒ SOME TESTS FAILED - CHECK LOGS"
            exit 1
          fi
