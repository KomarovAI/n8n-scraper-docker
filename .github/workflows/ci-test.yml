name: CI/CD Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker compose config > /dev/null
          echo "‚úÖ docker-compose.yml is valid"

      - name: Lint Dockerfiles with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile.n8n-enhanced
          ignore: DL3008,DL3009,DL3015

      - name: Check shell scripts
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          find . -type f -name "*.sh" -exec shellcheck {} \;
          echo "‚úÖ Shell scripts validated"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build n8n-enhanced image
        run: |
          docker buildx build \
            --file Dockerfile.n8n-enhanced \
            --tag n8n-scraper:test \
            --load \
            .
          echo "‚úÖ n8n-enhanced image built successfully"

      - name: Test image size
        run: |
          SIZE=$(docker images n8n-scraper:test --format "{{.Size}}")
          echo "Image size: $SIZE"
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–±—Ä–∞–∑ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (< 2GB)

  health-check:
    name: Health Check Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_DB=scraper_db
          POSTGRES_USER=scraper_user
          POSTGRES_PASSWORD=test_password_12345678901234567890
          REDIS_PASSWORD=test_redis_password_1234567890123456
          N8N_USER=admin
          N8N_PASSWORD=test_n8n_password_12345678901234567890
          TOR_CONTROL_PASSWORD=test_tor_password_1234567890123456
          GRAFANA_USER=admin
          GRAFANA_PASSWORD=test_grafana_password_12345678901234
          HUGGINGFACE_TOKEN=
          GRAFANA_ROOT_URL=http://localhost:3000
          EOF

      - name: Start services
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤
          docker compose up -d postgres redis prometheus grafana
          echo "‚è≥ Waiting for services to be healthy..."
          sleep 30

      - name: Check PostgreSQL health
        run: |
          docker compose exec -T postgres pg_isready -U scraper_user
          echo "‚úÖ PostgreSQL is healthy"

      - name: Check Redis health
        run: |
          docker compose exec -T redis redis-cli --no-auth-warning -a test_redis_password_1234567890123456 ping
          echo "‚úÖ Redis is healthy"

      - name: Check Prometheus health
        run: |
          curl -f http://localhost:9090/-/healthy || exit 1
          echo "‚úÖ Prometheus is healthy"

      - name: Check Grafana health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/health 2>/dev/null; then
              echo "‚úÖ Grafana is healthy"
              exit 0
            fi
            echo "Waiting for Grafana... ($i/30)"
            sleep 2
          done
          echo "‚ùå Grafana health check failed"
          exit 1

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Status ==="
          docker compose ps
          echo ""
          echo "=== Postgres Logs ==="
          docker compose logs postgres
          echo ""
          echo "=== Redis Logs ==="
          docker compose logs redis
          echo ""
          echo "=== Prometheus Logs ==="
          docker compose logs prometheus
          echo ""
          echo "=== Grafana Logs ==="
          docker compose logs grafana

      - name: Cleanup
        if: always()
        run: docker compose down -v

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, docker-build]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_DB=scraper_db
          POSTGRES_USER=scraper_user
          POSTGRES_PASSWORD=test_password_12345678901234567890
          REDIS_PASSWORD=test_redis_password_1234567890123456
          N8N_USER=admin
          N8N_PASSWORD=test_n8n_password_12345678901234567890
          TOR_CONTROL_PASSWORD=test_tor_password_1234567890123456
          GRAFANA_USER=admin
          GRAFANA_PASSWORD=test_grafana_password_12345678901234
          HUGGINGFACE_TOKEN=
          GRAFANA_ROOT_URL=http://localhost:3000
          EOF

      - name: Start full stack
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∫—Ä–æ–º–µ —Ç—è–∂–µ–ª—ã—Ö (ollama, ml-service)
          docker compose up -d postgres redis tor prometheus grafana node-exporter redis-exporter postgres-exporter
          echo "‚è≥ Waiting for all services..."
          sleep 45

      - name: Run integration tests
        run: |
          echo "üß™ Testing service connectivity..."
          
          # Test PostgreSQL
          docker compose exec -T postgres psql -U scraper_user -d scraper_db -c "SELECT 1;" > /dev/null
          echo "‚úÖ PostgreSQL query test passed"
          
          # Test Redis
          docker compose exec -T redis redis-cli --no-auth-warning -a test_redis_password_1234567890123456 SET test_key "test_value"
          docker compose exec -T redis redis-cli --no-auth-warning -a test_redis_password_1234567890123456 GET test_key | grep "test_value"
          echo "‚úÖ Redis read/write test passed"
          
          # Test Prometheus targets
          curl -s http://localhost:9090/api/v1/targets | jq -r '.data.activeTargets[].health' | grep -q "up" || exit 1
          echo "‚úÖ Prometheus targets check passed"
          
          # Test exporters
          curl -f http://localhost:9100/metrics > /dev/null
          echo "‚úÖ Node Exporter responding"
          
          curl -f http://localhost:9121/metrics > /dev/null
          echo "‚úÖ Redis Exporter responding"
          
          curl -f http://localhost:9187/metrics > /dev/null
          echo "‚úÖ PostgreSQL Exporter responding"

      - name: Test data persistence
        run: |
          echo "üß™ Testing data persistence..."
          
          # Write data
          docker compose exec -T postgres psql -U scraper_user -d scraper_db -c "CREATE TABLE IF NOT EXISTS test_table (id INT, data TEXT);"
          docker compose exec -T postgres psql -U scraper_user -d scraper_db -c "INSERT INTO test_table VALUES (1, 'test_data');"
          
          # Restart service
          docker compose restart postgres
          sleep 10
          
          # Read data
          docker compose exec -T postgres psql -U scraper_user -d scraper_db -c "SELECT * FROM test_table;" | grep "test_data"
          echo "‚úÖ Data persistence test passed"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, security-scan, docker-build, health-check, integration-test]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "üéâ All tests completed!"
          echo ""
          echo "Results:"
          echo "  ‚úÖ Lint & Validation"
          echo "  ‚úÖ Security Scan"
          echo "  ‚úÖ Docker Build"
          echo "  ‚úÖ Health Checks"
          echo "  ‚úÖ Integration Tests"
