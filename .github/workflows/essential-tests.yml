name: Essential Smoke Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  essential-tests:
    name: ðŸ§ª Essential Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“ Create .env from example
        run: |
          cp .env.example .env
          # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
          sed -i 's/CHANGE_ME_POSTGRES_PASSWORD/test_postgres_$(openssl rand -hex 8)/g' .env
          sed -i 's/CHANGE_ME_REDIS_PASSWORD/test_redis_$(openssl rand -hex 8)/g' .env
          sed -i 's/CHANGE_ME_N8N_PASSWORD/test_n8n_$(openssl rand -hex 8)/g' .env
          sed -i 's/CHANGE_ME_TOR_PASSWORD/test_tor_$(openssl rand -hex 8)/g' .env
          sed -i 's/CHANGE_ME_GRAFANA_PASSWORD/test_grafana_$(openssl rand -hex 8)/g' .env
      
      - name: ðŸ³ Start Docker services
        run: |
          docker-compose up -d n8n postgres redis prometheus grafana
          echo "âœ… Docker services started"
      
      - name: â±ï¸ Wait for services to be ready
        run: |
          echo "â³ Waiting 60 seconds for all services to start..."
          sleep 60
          echo "âœ… Services should be ready"
      
      - name: ðŸ“Š Check Docker containers status
        run: |
          echo "::group::Docker containers"
          docker-compose ps
          echo "::endgroup::"
      
      - name: ðŸ§ª Run Essential Test #1: Health Check
        run: |
          echo "::group::Test #1: Health Check"
          bash tests/essential/test_health.sh
          echo "::endgroup::"
      
      - name: ðŸš€ Run Essential Test #2: Workflow Smoke Test
        run: |
          echo "::group::Test #2: Workflow Smoke Test"
          bash tests/essential/test_workflow.sh
          echo "::endgroup::"
      
      - name: ðŸ“Š Show service logs on failure
        if: failure()
        run: |
          echo "::group::n8n logs"
          docker-compose logs --tail=100 n8n
          echo "::endgroup::"
          
          echo "::group::PostgreSQL logs"
          docker-compose logs --tail=50 postgres
          echo "::endgroup::"
          
          echo "::group::Redis logs"
          docker-compose logs --tail=50 redis
          echo "::endgroup::"
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker-compose down -v
          echo "âœ… Cleanup complete"
  
  summary:
    name: ðŸ“Š Test Summary
    needs: essential-tests
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ Generate summary
        run: |
          echo "# ðŸ§ª Essential Smoke Tests Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.essential-tests.result }}" == "success" ]; then
            echo "| Health Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| Workflow Test | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "System is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Essential Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ Tests failed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
