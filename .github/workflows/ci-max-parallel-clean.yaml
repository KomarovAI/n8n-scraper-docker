name: ðŸš€ CI/CD Maximum Parallel (Turbo)

# SECURITY: CVE-2025-62725 - Ensure Docker Compose v2.40.2+ (path traversal fix)
# https://nvd.nist.gov/vuln/detail/CVE-2025-62725

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ci-max-parallel-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  fast-validation:
    name: âš¡ Fast Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      start_time: ${{ steps.timer.outputs.start_time }}
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ³ Setup Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
      
      - name: ðŸ”’ Security scan
        run: |
          echo "Scanning for secrets..."
          docker run --rm -v "$(pwd)":/path trufflesecurity/trufflehog:latest filesystem /path --only-verified --fail || echo "No verified secrets"
          echo "Scan complete"
        continue-on-error: true
      
      - name: ðŸ³ Build and export
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.n8n-enhanced
          tags: n8n-enhanced:test
          outputs: type=docker,dest=/tmp/n8n-enhanced.tar
          cache-from: |
            type=gha,scope=buildkit-n8n-${{ github.ref_name }}
            type=gha,scope=buildkit-n8n-main
          cache-to: type=gha,mode=max,scope=buildkit-n8n-${{ github.ref_name }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1
      
      - name: ðŸ“¦ Compress image
        run: gzip -1 /tmp/n8n-enhanced.tar
      
      - name: ðŸ“¤ Upload image
        uses: actions/upload-artifact@v5
        with:
          name: n8n-enhanced-image
          path: /tmp/n8n-enhanced.tar.gz
          retention-days: 1
          compression-level: 0
      
      - name: ðŸ“Š Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          IMAGE_SIZE=$(stat -c%s /tmp/n8n-enhanced.tar.gz 2>/dev/null | awk '{print int($1/1024/1024)}' || echo 0)
          
          echo "Build completed in ${DURATION}s, image size: ${IMAGE_SIZE}MB" | tee /tmp/logs/fast-validation-test.log
          
          jq -n \
            --arg job "fast-validation" \
            --arg status "${{ job.status }}" \
            --argjson start "$START_TIME" \
            --argjson end "$END_TIME" \
            --argjson duration "$DURATION" \
            --arg exit_code "success" \
            --argjson image_size "$IMAGE_SIZE" \
            '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code, image_size_mb: $image_size}' \
            > /tmp/logs/fast-validation-metrics.json
      
      - name: ðŸ’¾ Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-fast-validation
          path: /tmp/logs/
          retention-days: 1

  smoke-tests:
    name: ðŸ’¨ Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: fast-validation
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "PostgreSQL", slug: "postgres", script: "tests/smoke/test_postgres_redis.sh", services: "postgres" }
          - { name: "Redis", slug: "redis", script: "tests/smoke/test_postgres_redis.sh", services: "redis" }
          - { name: "Tor", slug: "tor", script: "tests/smoke/test_tor.sh", services: "tor" }
          - { name: "Prometheus", slug: "prometheus", script: "tests/smoke/test_monitoring.sh", services: "prometheus" }
          - { name: "Grafana", slug: "grafana", script: "tests/smoke/test_monitoring.sh", services: "grafana" }
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¥ Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ðŸ“¦ Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ðŸ“ Create .env from secrets
        run: |
          cat > .env << EOF
          # Database & Cache
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          
          # n8n Authentication
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          
          # Tor Control
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          
          # Monitoring
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          
          # Optional API Keys
          FIRECRAWL_API_KEY=
          JINA_API_KEY=
          EOF
          echo "âœ… .env file created from GitHub Secrets"
      
      - name: ðŸš€ Start service
        run: docker compose up -d ${{ matrix.test.services }}
      
      - name: â±ï¸ Wait
        run: |
          for i in {1..30}; do
            docker compose ps | grep -q "Up" && { echo "Ready"; sleep 5; break; }
            sleep 2
          done
      
      - name: ðŸ§ª Run test
        id: test
        run: |
          chmod +x ${{ matrix.test.script }} || true
          bash ${{ matrix.test.script }} 2>&1 | tee /tmp/smoke-${{ matrix.test.slug }}-test.log
        continue-on-error: true
      
      - name: ðŸ“Š Save metrics
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          
          cp /tmp/smoke-${{ matrix.test.slug }}-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/smoke-${{ matrix.test.slug }}-test.log
          
          jq -n \
            --arg job "smoke-${{ matrix.test.slug }}" \
            --arg test_name "${{ matrix.test.name }}" \
            --arg status "${{ job.status }}" \
            --argjson start "$START_TIME" \
            --argjson end "$END_TIME" \
            --argjson duration "$DURATION" \
            --arg exit_code "${{ steps.test.outcome }}" \
            '{job: $job, test_name: $test_name, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' \
            > /tmp/logs/smoke-${{ matrix.test.slug }}-metrics.json
      
      - name: ðŸ’¾ Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-smoke-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  essential-tests:
    name: ðŸ§ª Essential Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "Health", slug: "health", script: "tests/essential/test_health.sh", services: "n8n postgres redis prometheus grafana" }
          - { name: "Workflow", slug: "workflow", script: "tests/essential/test_workflow.sh", services: "n8n postgres redis" }
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¥ Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ðŸ“¦ Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ðŸ“ Create .env from secrets
        run: |
          cat > .env << EOF
          # Database & Cache
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          
          # n8n Authentication
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          
          # Tor Control
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          
          # Monitoring
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          
          # Optional API Keys
          FIRECRAWL_API_KEY=
          JINA_API_KEY=
          EOF
          echo "âœ… .env file created from GitHub Secrets"
      
      - name: ðŸš€ Start services (optimized order)
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ postgres+redis ÑÐ½Ð°Ñ‡Ð°Ð»Ð°
          docker compose up -d postgres redis
          echo "Waiting for database..."
          sleep 8
          
          # Ð¢ÐµÐ¿ÐµÑ€ÑŒ n8n Ð¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³
          docker compose up -d ${{ matrix.test.services }}
          echo "Services started, waiting for initialization..."
      
      - name: â±ï¸ Wait for n8n (FAST - max 60s)
        run: |
          echo "âŒ› Waiting for n8n to start (max 60 seconds)..."
          START=$(date +%s)
          
          for i in {1..60}; do
            ELAPSED=$(($(date +%s) - START))
            
            # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¾Ð±Ð° endpoint'Ð°
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || \
               curl -sf http://localhost:5678 > /dev/null 2>&1; then
              echo "âœ… n8n is ready after ${ELAPSED}s!"
              docker compose ps
              exit 0
            fi
            
            # ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10Ñ
            if [ $((i % 10)) -eq 0 ]; then
              echo "âŒ› Still waiting... (${ELAPSED}s elapsed)"
              docker compose ps n8n postgres redis prometheus grafana 2>/dev/null || true
            fi
            
            sleep 1
          done
          
          # Timeout - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÑƒ
          echo "âŒ n8n failed to start after 60 seconds"
          echo "=== Container status ==="
          docker compose ps
          echo "=== n8n logs ==="
          docker compose logs --tail=100 n8n
          echo "=== PostgreSQL status ==="
          docker compose exec -T postgres pg_isready || true
          echo "=== Redis status ==="
          docker compose exec -T redis redis-cli ping || true
          exit 1
      
      - name: ðŸ§ª Run test
        id: test
        run: |
          chmod +x ${{ matrix.test.script }}
          bash ${{ matrix.test.script }} 2>&1 | tee /tmp/essential-${{ matrix.test.slug }}-test.log
        continue-on-error: true
      
      - name: ðŸ“Š Save metrics
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          
          cp /tmp/essential-${{ matrix.test.slug }}-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/essential-${{ matrix.test.slug }}-test.log
          docker compose logs n8n > /tmp/logs/essential-${{ matrix.test.slug }}-n8n.log 2>&1 || true
          
          jq -n \
            --arg job "essential-${{ matrix.test.slug }}" \
            --arg test_name "${{ matrix.test.name }}" \
            --arg status "${{ job.status }}" \
            --argjson start "$START_TIME" \
            --argjson end "$END_TIME" \
            --argjson duration "$DURATION" \
            --arg exit_code "${{ steps.test.outcome }}" \
            '{job: $job, test_name: $test_name, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' \
            > /tmp/logs/essential-${{ matrix.test.slug }}-metrics.json
      
      - name: ðŸ’¾ Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-essential-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  ml-services:
    name: ðŸ§  ML Services
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "Ollama", slug: "ollama", services: "ollama", timeout: 420 }
          - { name: "ML Service", slug: "ml-service", services: "ollama redis ml-service", timeout: 480 }
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¥ Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ðŸ“¦ Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ðŸ“ Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: ðŸš€ Start ML services
        run: |
          echo "ðŸ§  Starting ${{ matrix.test.name }}..."
          docker compose up -d ${{ matrix.test.services }}
      
      - name: â±ï¸ Wait for services (MAX timeout)
        run: |
          echo "âŒ› Waiting for ${{ matrix.test.name }} (max ${{ matrix.test.timeout }}s)..."
          START=$(date +%s)
          MAX_WAIT=${{ matrix.test.timeout }}
          
          while [ $(($(date +%s) - START)) -lt $MAX_WAIT ]; do
            ELAPSED=$(($(date +%s) - START))
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ollama
            if [ "${{ matrix.test.slug }}" = "ollama" ]; then
              if curl -sf http://localhost:11434/api/tags > /dev/null 2>&1; then
                echo "âœ… Ollama ready after ${ELAPSED}s!"
                exit 0
              fi
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ML Service
            if [ "${{ matrix.test.slug }}" = "ml-service" ]; then
              if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… ML Service ready after ${ELAPSED}s!"
                exit 0
              fi
            fi
            
            # ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 60Ñ
            if [ $((ELAPSED % 60)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
              echo "âŒ› Still waiting... (${ELAPSED}s / ${{ matrix.test.timeout }}s)"
              docker compose ps
            fi
            
            sleep 2
          done
          
          echo "âŒ Timeout after ${{ matrix.test.timeout }}s"
          docker compose logs --tail=100
          exit 1
      
      - name: ðŸ§ª Test ML endpoint
        id: test
        if: matrix.test.slug == 'ml-service'
        run: |
          echo "Testing ML Service API..."
          curl -v http://localhost:8000/health | tee /tmp/ml-${{ matrix.test.slug }}-test.log
        continue-on-error: true
      
      - name: ðŸ“Š Save metrics
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          
          cp /tmp/ml-${{ matrix.test.slug }}-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/ml-${{ matrix.test.slug }}-test.log
          docker compose logs ${{ matrix.test.services }} > /tmp/logs/ml-${{ matrix.test.slug }}-container.log 2>&1 || true
          
          jq -n \
            --arg job "ml-${{ matrix.test.slug }}" \
            --arg test_name "${{ matrix.test.name }}" \
            --arg status "${{ job.status }}" \
            --argjson start "$START_TIME" \
            --argjson end "$END_TIME" \
            --argjson duration "$DURATION" \
            --arg exit_code "${{ steps.test.outcome }}" \
            '{job: $job, test_name: $test_name, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' \
            > /tmp/logs/ml-${{ matrix.test.slug }}-metrics.json
      
      - name: ðŸ’¾ Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-ml-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  e2e-tests:
    name: ðŸŽ¯ E2E Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¥ Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ðŸ“¦ Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ðŸ“ Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: ðŸš€ Start stack (optimized)
        run: |
          docker compose up -d postgres redis
          sleep 8
          docker compose up -d n8n
      
      - name: â±ï¸ Wait for n8n (FAST - max 60s)
        run: |
          echo "âŒ› Waiting for n8n..."
          START=$(date +%s)
          
          for i in {1..60}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || \
               curl -sf http://localhost:5678 > /dev/null 2>&1; then
              ELAPSED=$(($(date +%s) - START))
              echo "âœ… n8n ready after ${ELAPSED}s"
              exit 0
            fi
            [ $((i % 10)) -eq 0 ] && echo "âŒ› Waiting... (${i}s)"
            sleep 1
          done
          
          echo "âŒ Timeout"
          docker compose logs --tail=50 n8n
          exit 1
      
      - name: ðŸŽ¯ Run test
        id: test
        run: |
          if [ -f "tests/e2e/workflow-test.js" ]; then
            node tests/e2e/workflow-test.js 2>&1 | tee /tmp/e2e-test.log
          else
            echo "âš ï¸  No E2E test file found - skipping" | tee /tmp/e2e-test.log
          fi
        continue-on-error: true
      
      - name: ðŸ“Š Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          cp /tmp/e2e-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/e2e-test.log
          docker compose logs n8n > /tmp/logs/e2e-n8n.log 2>&1 || true
          
          jq -n \
            --arg job "e2e" \
            --arg status "${{ job.status }}" \
            --argjson start "$START_TIME" \
            --argjson end "$END_TIME" \
            --argjson duration "$DURATION" \
            --arg exit_code "${{ steps.test.outcome }}" \
            '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' \
            > /tmp/logs/e2e-metrics.json
      
      - name: ðŸ’¾ Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-e2e
          path: /tmp/logs/
          retention-days: 1
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  n8n-integration:
    name: ðŸŒ Integration
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¥ Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ðŸ“¦ Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ðŸ“ Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: ðŸš€ Start n8n (optimized)
        run: |
          docker compose up -d postgres redis
          sleep 8
          docker compose up -d n8n
      
      - name: ðŸ” Verify (FAST - max 60s)
        run: |
          echo "âŒ› Verifying n8n..."
          START=$(date +%s)
          
          for i in {1..60}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || \
               curl -sf http://localhost:5678 > /dev/null 2>&1; then
              ELAPSED=$(($(date +%s) - START))
              echo "âœ… Accessible after ${ELAPSED}s"
              exit 0
            fi
            [ $((i % 10)) -eq 0 ] && echo "âŒ› Waiting... (${i}s)"
            sleep 1
          done
          
          echo "âŒ Failed"
          docker compose logs --tail=50 n8n
          exit 1
      
      - name: ðŸ§ª Run test
        id: test
        run: |
          if [ -f "tests/n8n/test_workflows.sh" ]; then
            chmod +x tests/n8n/test_workflows.sh
            bash tests/n8n/test_workflows.sh 2>&1 | tee /tmp/integration-test.log
          else
            echo "âš ï¸  No integration test - skipping" | tee /tmp/integration-test.log
          fi
        continue-on-error: true
      
      - name: ðŸ“Š Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          cp /tmp/integration-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/integration-test.log
          docker compose logs n8n > /tmp/logs/integration-n8n.log 2>&1 || true
          
          jq -n \
            --arg job "integration" \
            --arg status "${{ job.status }}" \
            --argjson start "$START_TIME" \
            --argjson end "$END_TIME" \
            --argjson duration "$DURATION" \
            --arg exit_code "${{ steps.test.outcome }}" \
            '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' \
            > /tmp/logs/integration-metrics.json
      
      - name: ðŸ’¾ Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-integration
          path: /tmp/logs/
          retention-days: 1
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  n8n-workflow-tests:
    name: ðŸ§ª n8n Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    outputs:
      duration: ${{ steps.save.outputs.duration }}
      passed: ${{ steps.save.outputs.passed }}
      failed: ${{ steps.save.outputs.failed }}
      success_rate: ${{ steps.save.outputs.success_rate }}
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¥ Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ðŸ“¦ Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ðŸ“ Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: ðŸš€ Start n8n stack
        run: |
          docker compose up -d postgres redis
          sleep 10
          docker compose up -d n8n
      
      - name: â±ï¸ Wait for n8n
        run: |
          echo "âŒ› Waiting for n8n..."
          for i in {1..60}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || \
               curl -sf http://localhost:5678 > /dev/null 2>&1; then
              echo "âœ… n8n ready after ${i}s"
              exit 0
            fi
            [ $((i % 10)) -eq 0 ] && echo "âŒ› Waiting... (${i}s)"
            sleep 1
          done
          echo "âŒ n8n failed to start"
          docker compose logs --tail=50 n8n
          exit 1
      
      - name: ðŸ§ª Test n8n workflows
        id: test
        run: |
          chmod +x scripts/test-n8n-workflows.sh
          
          export N8N_URL="http://localhost:5678"
          export N8N_USER="${{ secrets.N8N_USER_CI }}"
          export N8N_PASSWORD="${{ secrets.N8N_PASSWORD_CI }}"
          export WEBHOOK_PATH="/webhook-test/scrape"
          export TEST_TIMEOUT="30"
          export REPORT_FILE="/tmp/n8n-workflow-test-results.json"
          
          bash scripts/test-n8n-workflows.sh 2>&1 | tee /tmp/n8n-workflow-test.log
        continue-on-error: true
      
      - name: ðŸ“Š Parse test results
        id: parse
        if: always()
        run: |
          if [ -f "/tmp/n8n-workflow-test-results.json" ]; then
            PASSED=$(jq -r '.summary.passed' /tmp/n8n-workflow-test-results.json)
            FAILED=$(jq -r '.summary.failed' /tmp/n8n-workflow-test-results.json)
            SUCCESS_RATE=$(jq -r '.summary.success_rate' /tmp/n8n-workflow-test-results.json)
            
            echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
            echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=$SUCCESS_RATE" >> $GITHUB_OUTPUT
            
            echo "ðŸ“Š n8n Workflow Tests:"
            echo "  Passed: $PASSED"
            echo "  Failed: $FAILED"
            echo "  Success Rate: ${SUCCESS_RATE}%"
          else
            echo "PASSED=0" >> $GITHUB_OUTPUT
            echo "FAILED=0" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ No test results file found"
          fi
      
      - name: ðŸ“Š Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "passed=${{ steps.parse.outputs.PASSED }}" >> $GITHUB_OUTPUT
          echo "failed=${{ steps.parse.outputs.FAILED }}" >> $GITHUB_OUTPUT
          echo "success_rate=${{ steps.parse.outputs.SUCCESS_RATE }}" >> $GITHUB_OUTPUT
          
          cp /tmp/n8n-workflow-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/n8n-workflow-test.log
          cp /tmp/n8n-workflow-test-results.json /tmp/logs/ 2>/dev/null || echo "{}" > /tmp/logs/n8n-workflow-test-results.json
          docker compose logs n8n > /tmp/logs/n8n-workflow-n8n.log 2>&1 || true
          
          jq -n \
            --arg job "n8n-workflows" \
            --arg status "${{ job.status }}" \
            --argjson start "$START_TIME" \
            --argjson end "$END_TIME" \
            --argjson duration "$DURATION" \
            --arg exit_code "${{ steps.test.outcome }}" \
            --argjson passed "${{ steps.parse.outputs.PASSED }}" \
            --argjson failed "${{ steps.parse.outputs.FAILED }}" \
            --argjson success_rate "${{ steps.parse.outputs.SUCCESS_RATE }}" \
            '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code, passed: $passed, failed: $failed, success_rate: $success_rate}' \
            > /tmp/logs/n8n-workflows-metrics.json
      
      - name: ðŸ’¾ Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-n8n-workflows
          path: /tmp/logs/
          retention-days: 1
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  master-e2e:
    name: ðŸ† Master E2E
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [smoke-tests, essential-tests, e2e-tests, n8n-integration, ml-services, n8n-workflow-tests]
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¥ Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ðŸ“¦ Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ðŸ“ Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: ðŸš€ Start full stack (optimized)
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ
          docker compose up -d postgres redis
          sleep 12
          docker compose up -d n8n
          sleep 8
          docker compose up -d tor prometheus grafana
      
      - name: â±ï¸ Wait for services (max 90s)
        run: |
          echo "âŒ› Waiting for all services..."
          START=$(date +%s)
          
          # Ð–Ð´ÐµÐ¼ n8n
          for i in {1..90}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || \
               curl -sf http://localhost:5678 > /dev/null 2>&1; then
              ELAPSED=$(($(date +%s) - START))
              echo "âœ… n8n ready after ${ELAPSED}s"
              break
            fi
            [ $((i % 15)) -eq 0 ] && echo "âŒ› n8n starting... (${i}s)"
            sleep 1
          done
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
          sleep 10
          RUNNING=$(docker compose ps | grep -c "Up" || echo 0)
          echo "ðŸ“Š Running services: $RUNNING"
          
          if [ "$RUNNING" -ge 6 ]; then
            echo "âœ… All services ready"
            docker compose ps
          else
            echo "âš ï¸ Only $RUNNING services up, but continuing..."
            docker compose ps
          fi
      
      - name: ðŸ† Run MASTER TEST
        id: test
        run: |
          chmod +x tests/master/test_full_e2e.sh
          bash tests/master/test_full_e2e.sh 2>&1 | tee /tmp/master-test.log
        continue-on-error: true
      
      - name: ðŸ“Š Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          cp /tmp/master-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/master-test.log
          docker compose logs --tail=100 n8n > /tmp/logs/master-n8n.log 2>&1
          
          jq -n \
            --arg job "master" \
            --arg status "${{ job.status }}" \
            --argjson start "$START_TIME" \
            --argjson end "$END_TIME" \
            --argjson duration "$DURATION" \
            --arg exit_code "${{ steps.test.outcome }}" \
            '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' \
            > /tmp/logs/master-metrics.json
      
      - name: ðŸ’¾ Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-master
          path: /tmp/logs/
          retention-days: 1
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  ctrf-report:
    name: ðŸ“Š Final Report
    runs-on: ubuntu-latest
    needs: [fast-validation, smoke-tests, essential-tests, e2e-tests, n8n-integration, ml-services, n8n-workflow-tests, master-e2e]
    if: always()
    steps:
      - name: ðŸ“Š Checkout
        uses: actions/checkout@v6
      
      - name: ðŸ“¥ Download logs
        uses: actions/download-artifact@v6
        with:
          pattern: temp-logs-*
          path: all-temp-logs/
          merge-multiple: true
        continue-on-error: true
      
      - name: ðŸ”€ Merge logs
        run: |
          mkdir -p logs
          if [ -d "all-temp-logs" ]; then
            find all-temp-logs -type f -exec cp {} logs/ \;
          fi
          echo "Collected: $(ls -1 logs/ | wc -l) files"
      
      - name: ðŸ“Š Parse metrics
        run: |
          if ls logs/*-metrics.json 1> /dev/null 2>&1; then
            jq -s '.' logs/*-metrics.json > /tmp/all-metrics.json 2>/dev/null || echo "[]" > /tmp/all-metrics.json
          else
            echo "[]" > /tmp/all-metrics.json
          fi
          
          echo "Metrics parsed"
          cat /tmp/all-metrics.json
        continue-on-error: true
      
      - name: ðŸ” Extract errors
        run: |
          mkdir -p logs
          
          for logfile in logs/*-test.log; do
            if [ -f "$logfile" ]; then
              echo "=== $(basename $logfile) ==="
              grep -i "error\|fail" "$logfile" 2>/dev/null | head -5 || echo "No errors"
              echo ""
            fi
          done > logs/errors-detailed.txt
          
          echo "Errors extracted"
        continue-on-error: true
      
      - name: ðŸ“Š Generate CTRF
        run: |
          PASSED=0
          FAILED=0
          
          [ "${{ needs.fast-validation.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.smoke-tests.result }}" == "success" ] && PASSED=$((PASSED + 5)) || FAILED=$((FAILED + 5))
          [ "${{ needs.essential-tests.result }}" == "success" ] && PASSED=$((PASSED + 2)) || FAILED=$((FAILED + 2))
          [ "${{ needs.ml-services.result }}" == "success" ] && PASSED=$((PASSED + 2)) || FAILED=$((FAILED + 2))
          [ "${{ needs.e2e-tests.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.n8n-integration.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.n8n-workflow-tests.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.master-e2e.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          
          SUCCESS_RATE=$((PASSED * 100 / 14))
          
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "SUCCESS_RATE=$SUCCESS_RATE" >> $GITHUB_ENV
          
          DURATION_FAST=${{ needs.fast-validation.outputs.duration }}
          DURATION_E2E=${{ needs.e2e-tests.outputs.duration }}
          DURATION_INTEGRATION=${{ needs.n8n-integration.outputs.duration }}
          DURATION_WORKFLOWS=${{ needs.n8n-workflow-tests.outputs.duration }}
          DURATION_MASTER=${{ needs.master-e2e.outputs.duration }}
          TOTAL_DURATION=$((DURATION_FAST + DURATION_E2E + DURATION_INTEGRATION + DURATION_WORKFLOWS + DURATION_MASTER))
          
          jq -n \
            --argjson passed "$PASSED" \
            --argjson failed "$FAILED" \
            --argjson total_duration "$TOTAL_DURATION" \
            --argjson run "${{ github.run_number }}" \
            --arg sha "${{ github.sha }}" \
            '{
              summary: {
                tests: 14,
                passed: $passed,
                failed: $failed,
                duration: ($total_duration * 1000)
              },
              results: {
                tool: {
                  name: "GitHub Actions CI"
                },
                summary: {
                  tests: 14,
                  passed: $passed,
                  failed: $failed,
                  pending: 0,
                  skipped: 0,
                  other: 0,
                  start: 0,
                  stop: 0
                },
                tests: []
              },
              environment: {
                workflow_run: $run,
                workflow_sha: $sha
              }
            }' > logs/ctrf-report.json
          
          echo "CTRF generated"
          cat logs/ctrf-report.json
        continue-on-error: true
      
      - name: ðŸ“ Generate summary
        run: |
          jq -n \
            --argjson run "${{ github.run_number }}" \
            --arg sha "${{ github.sha }}" \
            --argjson passed "${PASSED:-0}" \
            --argjson failed "${FAILED:-0}" \
            --argjson rate "${SUCCESS_RATE:-0}" \
            '{
              run: $run,
              sha: $sha,
              passed: $passed,
              failed: $failed,
              success_rate: $rate
            }' > logs/summary.json
          
          echo "Summary generated"
          cat logs/summary.json
        continue-on-error: true
      
      - name: ðŸ“ Generate diagnostic
        run: |
          cat > logs/diagnostic.md << EOF
          # CI/CD Report (TURBO + n8n Workflows)
          
          ## Results
          
          - Fast Validation: ${{ needs.fast-validation.result }}
          - Smoke Tests: ${{ needs.smoke-tests.result }}
          - Essential Tests: ${{ needs.essential-tests.result }}
          - ML Services: ${{ needs.ml-services.result }}
          - E2E Tests: ${{ needs.e2e-tests.result }}
          - Integration: ${{ needs.n8n-integration.result }}
          - n8n Workflows: ${{ needs.n8n-workflow-tests.result }}
          - Master E2E: ${{ needs.master-e2e.result }}
          
          ## Stats
          
          - Passed: ${PASSED:-0}
          - Failed: ${FAILED:-0}
          - Rate: ${SUCCESS_RATE:-0}%
          
          ## n8n Workflow Tests Details
          
          - Passed: ${{ needs.n8n-workflow-tests.outputs.passed }}
          - Failed: ${{ needs.n8n-workflow-tests.outputs.failed }}
          - Success Rate: ${{ needs.n8n-workflow-tests.outputs.success_rate }}%
          EOF
          
          echo "Diagnostic generated"
        continue-on-error: true
      
      - name: ðŸ“ Workflow info
        run: |
          printf "Run: ${{ github.run_number }}\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}\n" > logs/workflow-info.txt
          ls -1 logs/ > logs/index.txt
          echo "Info generated"
        continue-on-error: true
      
      - name: ðŸ“Š Publish CTRF
        uses: ctrf-io/github-test-reporter@v1
        with:
          report-path: './logs/ctrf-report.json'
          summary-report: true
          test-report: true
          failed-report: true
        continue-on-error: true
      
      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ci-artifacts-full
          path: |
            logs/
          retention-days: 7
          compression-level: 9
        if: always()
      
      - name: ðŸ§¹ Cleanup
        uses: geekyeggo/delete-artifact@v5
        with:
          name: temp-logs-*
          failOnError: false
        if: always()
