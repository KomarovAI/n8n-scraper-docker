name: CI/CD Maximum Parallel

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ci-max-parallel-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  fast-validation:
    name: Fast Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      start_time: ${{ steps.timer.outputs.start_time }}
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
      
      - name: Security scan
        run: docker run --rm -v "$(pwd)":/path trufflesecurity/trufflehog:latest filesystem /path --only-verified --fail || echo "No verified secrets"
        continue-on-error: true
      
      - name: Build and export
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.n8n-enhanced
          tags: n8n-enhanced:test
          outputs: type=docker,dest=/tmp/n8n-enhanced.tar
          cache-from: |
            type=gha,scope=buildkit-n8n-${{ github.ref_name }}
            type=gha,scope=buildkit-n8n-main
          cache-to: type=gha,mode=max,scope=buildkit-n8n-${{ github.ref_name }}
          build-args: BUILDKIT_INLINE_CACHE=1
      
      - name: Compress image
        run: gzip -1 /tmp/n8n-enhanced.tar
      
      - name: Upload image
        uses: actions/upload-artifact@v5
        with:
          name: n8n-enhanced-image
          path: /tmp/n8n-enhanced.tar.gz
          retention-days: 1
          compression-level: 0
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          IMAGE_SIZE=$(stat -c%s /tmp/n8n-enhanced.tar.gz 2>/dev/null | awk '{print int($1/1024/1024)}' || echo 0)
          echo "Build completed in ${DURATION}s, image size: ${IMAGE_SIZE}MB" | tee /tmp/logs/fast-validation-test.log
          jq -n --arg job "fast-validation" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "success" --argjson image_size "$IMAGE_SIZE" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code, image_size_mb: $image_size}' > /tmp/logs/fast-validation-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-fast-validation
          path: /tmp/logs/
          retention-days: 1

  smoke-tests:
    name: Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: fast-validation
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "PostgreSQL", slug: "postgres", script: "tests/smoke/test_postgres_redis.sh", services: "postgres" }
          - { name: "Redis", slug: "redis", script: "tests/smoke/test_postgres_redis.sh", services: "redis" }
          - { name: "Tor", slug: "tor", script: "tests/smoke/test_tor.sh", services: "tor" }
          - { name: "Prometheus", slug: "prometheus", script: "tests/smoke/test_monitoring.sh", services: "prometheus" }
          - { name: "Grafana", slug: "grafana", script: "tests/smoke/test_monitoring.sh", services: "grafana" }
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          # Database & Cache
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          
          # n8n Authentication
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          
          # Tor Control
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          
          # Monitoring
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          
          # Optional API Keys
          FIRECRAWL_API_KEY=
          JINA_API_KEY=
          EOF
      
      - name: Start service
        run: docker compose up -d ${{ matrix.test.services }}
      
      - name: Wait for service
        run: for i in {1..30}; do docker compose ps | grep -q "Up" && { sleep 5; break; }; sleep 2; done
      
      - name: Run test
        id: test
        run: |
          chmod +x ${{ matrix.test.script }} || true
          bash ${{ matrix.test.script }} 2>&1 | tee /tmp/smoke-${{ matrix.test.slug }}-test.log
        continue-on-error: true
      
      - name: Save metrics
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          cp /tmp/smoke-${{ matrix.test.slug }}-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/smoke-${{ matrix.test.slug }}-test.log
          jq -n --arg job "smoke-${{ matrix.test.slug }}" --arg test_name "${{ matrix.test.name }}" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, test_name: $test_name, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/smoke-${{ matrix.test.slug }}-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-smoke-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  essential-tests:
    name: Essential Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "Health", slug: "health", script: "tests/essential/test_health.sh", services: "n8n postgres redis prometheus grafana" }
          - { name: "Workflow", slug: "workflow", script: "tests/essential/test_workflow.sh", services: "n8n postgres redis" }
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          # Database & Cache
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          
          # n8n Authentication
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          
          # Tor Control
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          
          # Monitoring
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          
          # Optional API Keys
          FIRECRAWL_API_KEY=
          JINA_API_KEY=
          EOF
      
      - name: Start services
        run: |
          docker compose up -d postgres redis
          sleep 8
          docker compose up -d ${{ matrix.test.services }}
      
      - name: Wait for n8n
        run: |
          START=$(date +%s)
          for i in {1..60}; do
            ELAPSED=$(($(date +%s) - START))
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || curl -sf http://localhost:5678 > /dev/null 2>&1; then
              docker compose ps
              exit 0
            fi
            [ $((i % 10)) -eq 0 ] && docker compose ps n8n postgres redis prometheus grafana 2>/dev/null || true
            sleep 1
          done
          docker compose ps
          docker compose logs --tail=100 n8n
          docker compose exec -T postgres pg_isready || true
          docker compose exec -T redis redis-cli ping || true
          exit 1
      
      - name: Run test
        id: test
        run: |
          chmod +x ${{ matrix.test.script }}
          bash ${{ matrix.test.script }} 2>&1 | tee /tmp/essential-${{ matrix.test.slug }}-test.log
        continue-on-error: true
      
      - name: Save metrics
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          cp /tmp/essential-${{ matrix.test.slug }}-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/essential-${{ matrix.test.slug }}-test.log
          docker compose logs n8n > /tmp/logs/essential-${{ matrix.test.slug }}-n8n.log 2>&1 || true
          jq -n --arg job "essential-${{ matrix.test.slug }}" --arg test_name "${{ matrix.test.name }}" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, test_name: $test_name, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/essential-${{ matrix.test.slug }}-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-essential-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  ml-services:
    name: ML Services
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "Ollama", slug: "ollama", services: "ollama", timeout: 600 }
          - { name: "ML Service", slug: "ml-service", services: "ollama redis ml-service", timeout: 600 }
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start ML services
        run: docker compose up -d ${{ matrix.test.services }}
      
      - name: Wait for services
        run: |
          START=$(date +%s)
          MAX_WAIT=${{ matrix.test.timeout }}
          while [ $(($(date +%s) - START)) -lt $MAX_WAIT ]; do
            ELAPSED=$(($(date +%s) - START))
            [ "${{ matrix.test.slug }}" = "ollama" ] && curl -sf http://localhost:11434/api/tags > /dev/null 2>&1 && exit 0
            [ "${{ matrix.test.slug }}" = "ml-service" ] && curl -sf http://localhost:8000/health > /dev/null 2>&1 && exit 0
            [ $((ELAPSED % 60)) -eq 0 ] && [ $ELAPSED -gt 0 ] && docker compose ps
            sleep 2
          done
          docker compose logs --tail=100
          exit 1
      
      - name: Test ML endpoint
        id: test
        if: matrix.test.slug == 'ml-service'
        run: curl -v http://localhost:8000/health | tee /tmp/ml-${{ matrix.test.slug }}-test.log
        continue-on-error: true
      
      - name: Save metrics
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          cp /tmp/ml-${{ matrix.test.slug }}-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/ml-${{ matrix.test.slug }}-test.log
          docker compose logs ${{ matrix.test.services }} > /tmp/logs/ml-${{ matrix.test.slug }}-container.log 2>&1 || true
          jq -n --arg job "ml-${{ matrix.test.slug }}" --arg test_name "${{ matrix.test.name }}" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, test_name: $test_name, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/ml-${{ matrix.test.slug }}-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-ml-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  e2e-tests:
    name: E2E Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start stack
        run: |
          docker compose up -d postgres redis
          sleep 8
          docker compose up -d n8n
      
      - name: Wait for n8n
        run: |
          START=$(date +%s)
          for i in {1..60}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || curl -sf http://localhost:5678 > /dev/null 2>&1; then
              ELAPSED=$(($(date +%s) - START))
              exit 0
            fi
            [ $((i % 10)) -eq 0 ] && echo "Waiting ${i}s"
            sleep 1
          done
          docker compose logs --tail=50 n8n
          exit 1
      
      - name: Run test
        id: test
        run: |
          if [ -f "tests/e2e/workflow-test.js" ]; then
            node tests/e2e/workflow-test.js 2>&1 | tee /tmp/e2e-test.log
          else
            echo "No E2E test file found - skipping" | tee /tmp/e2e-test.log
          fi
        continue-on-error: true
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cp /tmp/e2e-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/e2e-test.log
          docker compose logs n8n > /tmp/logs/e2e-n8n.log 2>&1 || true
          jq -n --arg job "e2e" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/e2e-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-e2e
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  n8n-integration:
    name: Integration
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start n8n
        run: |
          docker compose up -d postgres redis
          sleep 8
          docker compose up -d n8n
      
      - name: Verify n8n
        run: |
          START=$(date +%s)
          for i in {1..60}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || curl -sf http://localhost:5678 > /dev/null 2>&1; then
              ELAPSED=$(($(date +%s) - START))
              exit 0
            fi
            [ $((i % 10)) -eq 0 ] && echo "Waiting ${i}s"
            sleep 1
          done
          docker compose logs --tail=50 n8n
          exit 1
      
      - name: Run test
        id: test
        run: |
          if [ -f "tests/n8n/test_workflows.sh" ]; then
            chmod +x tests/n8n/test_workflows.sh
            bash tests/n8n/test_workflows.sh 2>&1 | tee /tmp/integration-test.log
          else
            echo "No integration test - skipping" | tee /tmp/integration-test.log
          fi
        continue-on-error: true
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cp /tmp/integration-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/integration-test.log
          docker compose logs n8n > /tmp/logs/integration-n8n.log 2>&1 || true
          jq -n --arg job "integration" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/integration-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-integration
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  n8n-workflow-tests:
    name: n8n Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    outputs:
      duration: ${{ steps.save.outputs.duration }}
      passed: ${{ steps.save.outputs.passed }}
      failed: ${{ steps.save.outputs.failed }}
      success_rate: ${{ steps.save.outputs.success_rate }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start n8n stack
        run: |
          docker compose up -d postgres redis
          sleep 10
          docker compose up -d n8n
      
      - name: Wait for n8n
        run: |
          START=$(date +%s)
          for i in {1..90}; do
            ELAPSED=$(($(date +%s) - START))
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || curl -sf http://localhost:5678 > /dev/null 2>&1; then
              sleep 10
              docker compose ps
              exit 0
            fi
            [ $((i % 15)) -eq 0 ] && docker compose ps n8n postgres redis 2>/dev/null || true
            sleep 1
          done
          docker compose logs --tail=100 n8n
          exit 1
      
      - name: Import n8n workflows via API
        run: |
          chmod +x scripts/import-n8n-workflows.sh
          export N8N_URL="http://localhost:5678"
          export N8N_USER="${{ secrets.N8N_USER_CI }}"
          export N8N_PASSWORD="${{ secrets.N8N_PASSWORD_CI }}"
          export WORKFLOWS_DIR="workflows"
          bash scripts/import-n8n-workflows.sh 2>&1 | tee /tmp/import-workflows.log
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            cat /tmp/import-workflows.log
            docker compose logs --tail=100 n8n
            exit $EXIT_CODE
          fi
      
      - name: Test n8n workflows
        id: test
        run: |
          chmod +x scripts/test-n8n-workflows.sh
          export N8N_URL="http://localhost:5678"
          export N8N_USER="${{ secrets.N8N_USER_CI }}"
          export N8N_PASSWORD="${{ secrets.N8N_PASSWORD_CI }}"
          export WEBHOOK_PATH="/webhook-test/scrape"
          export TEST_TIMEOUT="30"
          export REPORT_FILE="/tmp/n8n-workflow-test-results.json"
          bash scripts/test-n8n-workflows.sh 2>&1 | tee /tmp/n8n-workflow-test.log
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            docker compose logs --tail=100 n8n
            exit $EXIT_CODE
          fi
      
      - name: Parse test results
        id: parse
        if: always()
        run: |
          if [ -f "/tmp/n8n-workflow-test-results.json" ]; then
            PASSED=$(jq -r '.summary.passed' /tmp/n8n-workflow-test-results.json)
            FAILED=$(jq -r '.summary.failed' /tmp/n8n-workflow-test-results.json)
            SUCCESS_RATE=$(jq -r '.summary.success_rate' /tmp/n8n-workflow-test-results.json)
            echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
            echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          else
            echo "PASSED=0" >> $GITHUB_OUTPUT
            echo "FAILED=0" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "passed=${{ steps.parse.outputs.PASSED }}" >> $GITHUB_OUTPUT
          echo "failed=${{ steps.parse.outputs.FAILED }}" >> $GITHUB_OUTPUT
          echo "success_rate=${{ steps.parse.outputs.SUCCESS_RATE }}" >> $GITHUB_OUTPUT
          cp /tmp/n8n-workflow-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/n8n-workflow-test.log
          cp /tmp/import-workflows.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/import-workflows.log
          cp /tmp/n8n-workflow-test-results.json /tmp/logs/ 2>/dev/null || echo "{}" > /tmp/logs/n8n-workflow-test-results.json
          docker compose logs n8n > /tmp/logs/n8n-workflow-n8n.log 2>&1 || true
          jq -n --arg job "n8n-workflows" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" --argjson passed "${{ steps.parse.outputs.PASSED }}" --argjson failed "${{ steps.parse.outputs.FAILED }}" --argjson success_rate "${{ steps.parse.outputs.SUCCESS_RATE }}" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code, passed: $passed, failed: $failed, success_rate: $success_rate}' > /tmp/logs/n8n-workflows-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-n8n-workflows
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  master-e2e:
    name: Master E2E
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [smoke-tests, essential-tests, e2e-tests, n8n-integration, ml-services, n8n-workflow-tests]
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start full stack
        run: |
          docker compose up -d postgres redis
          sleep 12
          docker compose up -d n8n
          sleep 8
          docker compose up -d tor prometheus grafana
      
      - name: Wait for services
        run: |
          START=$(date +%s)
          for i in {1..90}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || curl -sf http://localhost:5678 > /dev/null 2>&1; then
              ELAPSED=$(($(date +%s) - START))
              break
            fi
            [ $((i % 15)) -eq 0 ] && echo "Waiting ${i}s"
            sleep 1
          done
          sleep 10
          RUNNING=$(docker compose ps | grep -c "Up" || echo 0)
          docker compose ps
      
      - name: Run MASTER TEST
        id: test
        run: |
          chmod +x tests/master/test_full_e2e.sh
          bash tests/master/test_full_e2e.sh 2>&1 | tee /tmp/master-test.log
        continue-on-error: true
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cp /tmp/master-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/master-test.log
          docker compose logs --tail=100 n8n > /tmp/logs/master-n8n.log 2>&1
          jq -n --arg job "master" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/master-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: temp-logs-master
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  ctrf-report:
    name: Final Report
    runs-on: ubuntu-latest
    needs: [fast-validation, smoke-tests, essential-tests, e2e-tests, n8n-integration, ml-services, n8n-workflow-tests, master-e2e]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Download logs
        uses: actions/download-artifact@v6
        with:
          pattern: temp-logs-*
          path: all-temp-logs/
          merge-multiple: true
        continue-on-error: true
      
      - name: Merge logs
        run: |
          mkdir -p logs
          [ -d "all-temp-logs" ] && find all-temp-logs -type f -exec cp {} logs/ \;
      
      - name: Parse metrics
        run: |
          ls logs/*-metrics.json 1> /dev/null 2>&1 && jq -s '.' logs/*-metrics.json > /tmp/all-metrics.json || echo "[]" > /tmp/all-metrics.json
        continue-on-error: true
      
      - name: Extract errors
        run: |
          mkdir -p logs
          for f in logs/*-test.log; do [ -f "$f" ] && { echo "=== $(basename $f) ==="; grep -i "error\|fail" "$f" 2>/dev/null | head -5 || echo "No errors"; }; done > logs/errors-detailed.txt
        continue-on-error: true
      
      - name: Generate CTRF
        run: |
          PASSED=0
          FAILED=0
          [ "${{ needs.fast-validation.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.smoke-tests.result }}" == "success" ] && PASSED=$((PASSED + 5)) || FAILED=$((FAILED + 5))
          [ "${{ needs.essential-tests.result }}" == "success" ] && PASSED=$((PASSED + 2)) || FAILED=$((FAILED + 2))
          [ "${{ needs.ml-services.result }}" == "success" ] && PASSED=$((PASSED + 2)) || FAILED=$((FAILED + 2))
          [ "${{ needs.e2e-tests.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.n8n-integration.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.n8n-workflow-tests.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.master-e2e.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          SUCCESS_RATE=$((PASSED * 100 / 14))
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "SUCCESS_RATE=$SUCCESS_RATE" >> $GITHUB_ENV
          TOTAL_DURATION=$((${{ needs.fast-validation.outputs.duration }} + ${{ needs.e2e-tests.outputs.duration }} + ${{ needs.n8n-integration.outputs.duration }} + ${{ needs.n8n-workflow-tests.outputs.duration }} + ${{ needs.master-e2e.outputs.duration }}))
          jq -n --argjson p "$PASSED" --argjson f "$FAILED" --argjson d "$TOTAL_DURATION" --argjson r "${{ github.run_number }}" --arg s "${{ github.sha }}" '{summary:{tests:14,passed:$p,failed:$f,duration:($d*1000)},results:{tool:{name:"GitHub Actions CI"},summary:{tests:14,passed:$p,failed:$f,pending:0,skipped:0,other:0,start:0,stop:0},tests:[]},environment:{workflow_run:$r,workflow_sha:$s}}' > logs/ctrf-report.json
        continue-on-error: true
      
      - name: Generate summary
        run: |
          jq -n --argjson r "${{ github.run_number }}" --arg s "${{ github.sha }}" --argjson p "${PASSED:-0}" --argjson f "${FAILED:-0}" --argjson rt "${SUCCESS_RATE:-0}" '{run:$r,sha:$s,passed:$p,failed:$f,success_rate:$rt}' > logs/summary.json
        continue-on-error: true
      
      - name: Generate diagnostic
        run: |
          cat > logs/diagnostic.md << EOF
          # CI/CD Report
          
          - Fast: ${{ needs.fast-validation.result }}
          - Smoke: ${{ needs.smoke-tests.result }}
          - Essential: ${{ needs.essential-tests.result }}
          - ML: ${{ needs.ml-services.result }}
          - E2E: ${{ needs.e2e-tests.result }}
          - Integration: ${{ needs.n8n-integration.result }}
          - n8n Workflows: ${{ needs.n8n-workflow-tests.result }}
          - Master: ${{ needs.master-e2e.result }}
          
          Stats: ${PASSED:-0} passed, ${FAILED:-0} failed, ${SUCCESS_RATE:-0}%
          EOF
        continue-on-error: true
      
      - name: Workflow info
        run: |
          printf "Run: ${{ github.run_number }}\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}\n" > logs/workflow-info.txt
          ls -1 logs/ > logs/index.txt
        continue-on-error: true
      
      - name: Publish CTRF
        uses: ctrf-io/github-test-reporter@v1
        with:
          report-path: './logs/ctrf-report.json'
          summary-report: true
          test-report: true
          failed-report: true
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ci-artifacts-full
          path: logs/
          retention-days: 7
          compression-level: 9
        if: always()
      
      - name: Cleanup
        uses: geekyeggo/delete-artifact@v5
        with:
          name: temp-logs-*
          failOnError: false
        if: always()
