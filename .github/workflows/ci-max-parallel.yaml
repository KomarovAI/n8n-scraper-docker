name: ğŸš€ Maximum Parallel CI/CD (Ultra-Optimized)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Job 1: Fast validation
  fast-validation:
    name: âš¡ Fast Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“Š Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ“¦ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: ğŸ” Lint YAML files
        run: |
          echo "âœ“ Linting docker-compose.yml"
          docker run --rm -v "$(pwd)":/workspace mikefarah/yq eval '.services' docker-compose.yml > /dev/null 2>&1 || echo "âš ï¸ YQ check failed"
          echo "âœ… YAML valid"
      
      - name: ğŸ”’ Security scan
        run: |
          echo "ğŸ” Scanning for secrets..."
          docker run --rm -v "$(pwd)":/path trufflesecurity/trufflehog:latest filesystem /path --only-verified --fail 2>&1 | tee /tmp/security-scan.log || echo "âš ï¸ No verified secrets"
          echo "âœ… Scan complete"
      
      - name: ğŸ³ Build Docker image
        id: docker-build
        run: |
          echo "ğŸ› ï¸ Building n8n-enhanced..."
          echo "========== BUILD START $(date) =========="
          
          docker build -f Dockerfile.n8n-enhanced -t n8n-enhanced:test . 2>&1 | tee /tmp/docker-build-full.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          echo "========== BUILD END $(date) =========="
          echo "Exit code: $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… Build successful"
            docker images | grep n8n-enhanced | tee /tmp/docker-image-info.log
          else
            echo "âŒ Build failed with exit code $BUILD_EXIT_CODE"
            tail -50 /tmp/docker-build-full.log
            exit $BUILD_EXIT_CODE
          fi
      
      - name: ğŸ“¦ Save Docker image
        if: success()
        run: |
          echo "ğŸ’¾ Saving Docker image..."
          docker save n8n-enhanced:test | gzip > /tmp/n8n-enhanced.tar.gz
          ls -lh /tmp/n8n-enhanced.tar.gz
          echo "âœ… Image saved"
      
      - name: ğŸ“¤ Upload Docker image
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: n8n-enhanced-image
          path: /tmp/n8n-enhanced.tar.gz
          retention-days: 1
      
      - name: ğŸ“ Save logs FLAT with DEBUG
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          # ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸
          cp /tmp/docker-build-full.log /tmp/logs/fast-validation-build-full.log 2>/dev/null || echo "No full build log" > /tmp/logs/fast-validation-build-full.log
          cp /tmp/docker-image-info.log /tmp/logs/fast-validation-image-info.log 2>/dev/null || echo "No image info" > /tmp/logs/fast-validation-image-info.log
          cp /tmp/security-scan.log /tmp/logs/fast-validation-security.log 2>/dev/null || echo "No security log" > /tmp/logs/fast-validation-security.log
          
          # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
          echo "${{ job.status }}" > /tmp/logs/fast-validation-status.txt
          echo "Job: ${{ github.job }}" > /tmp/logs/fast-validation-meta.txt
          echo "Run: ${{ github.run_number }}" >> /tmp/logs/fast-validation-meta.txt
          echo "Time: $(date -u)" >> /tmp/logs/fast-validation-meta.txt
          
          # DEBUG: Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸
          echo "ğŸ“ Files saved:"
          ls -lh /tmp/logs/fast-validation-*
      
      - name: ğŸ’¾ Upload temp logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: temp-logs-fast-validation
          path: /tmp/logs/
          retention-days: 1

  # Job 2: Smoke tests
  smoke-tests:
    name: ğŸ’¨ Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-validation
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "PostgreSQL", slug: "postgres", script: "tests/smoke/test_postgres_redis.sh", services: "postgres" }
          - { name: "Redis", slug: "redis", script: "tests/smoke/test_postgres_redis.sh", services: "redis" }
          - { name: "Tor", slug: "tor", script: "tests/smoke/test_tor.sh", services: "tor" }
          - { name: "Prometheus", slug: "prometheus", script: "tests/smoke/test_monitoring.sh", services: "prometheus" }
          - { name: "Grafana", slug: "grafana", script: "tests/smoke/test_monitoring.sh", services: "grafana" }
    steps:
      - name: ğŸ“Š Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ğŸ“¦ Load Docker image
        run: |
          echo "ğŸ”„ Loading image..."
          docker load < /tmp/n8n-enhanced.tar.gz
          docker images
      
      - name: ğŸ“ Create .env
        run: |
          cp .env.example .env
          sed -i "s/CHANGE_ME_POSTGRES_PASSWORD/test_pg_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_REDIS_PASSWORD/test_redis_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_N8N_PASSWORD/test_n8n_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_TOR_PASSWORD/test_tor_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_GRAFANA_PASSWORD/test_grafana_$(openssl rand -hex 12)/g" .env
      
      - name: ğŸš€ Start service
        run: |
          echo "â–¶ï¸ Starting: ${{ matrix.test.services }}"
          docker-compose up -d ${{ matrix.test.services }} 2>&1 | tee /tmp/smoke-${{ matrix.test.slug }}-start.log
          echo "âœ… Started"
      
      - name: â±ï¸ Wait for service
        run: |
          echo "â³ Waiting for ${{ matrix.test.name }}..."
          for i in {1..30}; do
            docker-compose ps | grep -q "Up" && { echo "âœ… Ready"; sleep 5; break; }
            sleep 2
          done
          docker-compose ps > /tmp/smoke-${{ matrix.test.slug }}-ps-after-wait.log
      
      - name: ğŸ§ª Run test
        run: |
          chmod +x ${{ matrix.test.script }} || true
          echo "========== TEST START $(date) =========="
          bash ${{ matrix.test.script }} 2>&1 | tee /tmp/smoke-${{ matrix.test.slug }}-test-full.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "========== TEST END $(date) =========="
          echo "Exit code: $TEST_EXIT_CODE"
          exit $TEST_EXIT_CODE
      
      - name: ğŸ“ Save logs FLAT with DEBUG
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          # Docker ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
          docker-compose ps > /tmp/logs/smoke-${{ matrix.test.slug }}-ps.log 2>&1
          docker-compose logs --tail=200 > /tmp/logs/smoke-${{ matrix.test.slug }}-docker.log 2>&1
          
          # Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸
          cp /tmp/smoke-${{ matrix.test.slug }}-start.log /tmp/logs/ 2>/dev/null || echo "No start log" > /tmp/logs/smoke-${{ matrix.test.slug }}-start.log
          cp /tmp/smoke-${{ matrix.test.slug }}-test-full.log /tmp/logs/ 2>/dev/null || echo "No test log" > /tmp/logs/smoke-${{ matrix.test.slug }}-test-full.log
          cp /tmp/smoke-${{ matrix.test.slug }}-ps-after-wait.log /tmp/logs/ 2>/dev/null || echo "No ps log" > /tmp/logs/smoke-${{ matrix.test.slug }}-ps-after-wait.log
          
          # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ
          echo "${{ job.status }}" > /tmp/logs/smoke-${{ matrix.test.slug }}-status.txt
          
          # DEBUG
          echo "ğŸ“ Files saved for smoke-${{ matrix.test.slug }}:"
          ls -lh /tmp/logs/smoke-${{ matrix.test.slug }}-*
      
      - name: ğŸ’¾ Upload temp logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: temp-logs-smoke-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: docker-compose down -v

  # Job 3: Essential tests
  essential-tests:
    name: ğŸ§ª Essential Test
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: fast-validation
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "Health", slug: "health", script: "tests/essential/test_health.sh", services: "n8n postgres redis" }
          - { name: "Workflow", slug: "workflow", script: "tests/essential/test_workflow.sh", services: "n8n postgres redis" }
    steps:
      - name: ğŸ“Š Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ğŸ“¦ Load Docker image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ğŸ“ Create .env
        run: |
          cp .env.example .env
          sed -i "s/CHANGE_ME_POSTGRES_PASSWORD/test_pg_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_REDIS_PASSWORD/test_redis_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_N8N_PASSWORD/test_n8n_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_TOR_PASSWORD/test_tor_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_GRAFANA_PASSWORD/test_grafana_$(openssl rand -hex 12)/g" .env
      
      - name: ğŸš€ Start services
        run: |
          echo "â–¶ï¸ Starting: ${{ matrix.test.services }}"
          docker-compose up -d ${{ matrix.test.services }} 2>&1 | tee /tmp/essential-${{ matrix.test.slug }}-start.log
      
      - name: â±ï¸ Wait for n8n
        run: |
          echo "â³ Waiting for n8n API..."
          for i in {1..40}; do
            if curl -sf http://localhost:5678 > /dev/null 2>&1; then
              echo "âœ… n8n ready"
              break
            fi
            echo "Attempt $i/40..."
            sleep 3
          done
          curl -v http://localhost:5678 2>&1 | tee /tmp/essential-${{ matrix.test.slug }}-curl.log || true
      
      - name: ğŸ§ª Run test
        run: |
          chmod +x ${{ matrix.test.script }}
          echo "========== TEST START $(date) =========="
          bash ${{ matrix.test.script }} 2>&1 | tee /tmp/essential-${{ matrix.test.slug }}-test-full.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "========== TEST END $(date) =========="
          exit $TEST_EXIT_CODE
      
      - name: ğŸ“ Save logs FLAT with DEBUG
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          docker-compose ps > /tmp/logs/essential-${{ matrix.test.slug }}-ps.log 2>&1
          docker-compose logs --tail=300 > /tmp/logs/essential-${{ matrix.test.slug }}-docker.log 2>&1
          
          cp /tmp/essential-${{ matrix.test.slug }}-start.log /tmp/logs/ 2>/dev/null || echo "No start log" > /tmp/logs/essential-${{ matrix.test.slug }}-start.log
          cp /tmp/essential-${{ matrix.test.slug }}-test-full.log /tmp/logs/ 2>/dev/null || echo "No test log" > /tmp/logs/essential-${{ matrix.test.slug }}-test-full.log
          cp /tmp/essential-${{ matrix.test.slug }}-curl.log /tmp/logs/ 2>/dev/null || echo "No curl log" > /tmp/logs/essential-${{ matrix.test.slug }}-curl.log
          
          echo "${{ job.status }}" > /tmp/logs/essential-${{ matrix.test.slug }}-status.txt
          
          echo "ğŸ“ Files saved for essential-${{ matrix.test.slug }}:"
          ls -lh /tmp/logs/essential-${{ matrix.test.slug }}-*
      
      - name: ğŸ’¾ Upload temp logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: temp-logs-essential-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: docker-compose down -v

  # Job 4: E2E tests
  e2e-tests:
    name: ğŸ¯ E2E Test
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: fast-validation
    steps:
      - name: ğŸ“Š Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'tests/e2e/package.json'
      
      - name: ğŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ğŸ“¦ Load Docker image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ğŸ“ Create .env
        run: |
          cp .env.example .env
          sed -i "s/CHANGE_ME_POSTGRES_PASSWORD/test_pg_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_REDIS_PASSWORD/test_redis_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_N8N_PASSWORD/test_n8n_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_TOR_PASSWORD/test_tor_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_GRAFANA_PASSWORD/test_grafana_$(openssl rand -hex 12)/g" .env
      
      - name: ğŸš€ Start stack
        run: docker-compose up -d n8n postgres redis 2>&1 | tee /tmp/e2e-start.log
      
      - name: â±ï¸ Wait for n8n
        run: |
          for i in {1..40}; do
            curl -sf http://localhost:5678 > /dev/null 2>&1 && { echo "âœ… n8n ready"; break; }
            sleep 3
          done
      
      - name: ğŸ“¦ Install dependencies
        working-directory: tests/e2e
        run: npm install 2>&1 | tee /tmp/e2e-npm-install.log || echo "No package.json"
      
      - name: ğŸ¯ Run E2E test
        working-directory: tests/e2e
        run: |
          if [ -f "workflow-test.js" ]; then
            echo "========== E2E TEST START =========="
            node workflow-test.js 2>&1 | tee /tmp/e2e-test-full.log
            echo "========== E2E TEST END =========="
          else
            echo "âš ï¸ No E2E test" | tee /tmp/e2e-test-full.log
          fi
      
      - name: ğŸ“ Save logs FLAT with DEBUG
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          docker-compose logs --tail=300 n8n > /tmp/logs/e2e-docker-n8n.log 2>&1
          docker-compose ps > /tmp/logs/e2e-ps.log 2>&1
          
          cp /tmp/e2e-start.log /tmp/logs/ 2>/dev/null || echo "No start log" > /tmp/logs/e2e-start.log
          cp /tmp/e2e-test-full.log /tmp/logs/ 2>/dev/null || echo "No test log" > /tmp/logs/e2e-test-full.log
          cp /tmp/e2e-npm-install.log /tmp/logs/ 2>/dev/null || echo "No npm log" > /tmp/logs/e2e-npm-install.log
          
          echo "${{ job.status }}" > /tmp/logs/e2e-status.txt
          
          echo "ğŸ“ Files saved for e2e:"
          ls -lh /tmp/logs/e2e-*
      
      - name: ğŸ’¾ Upload temp logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: temp-logs-e2e
          path: /tmp/logs/
          retention-days: 1
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: docker-compose down -v

  # Job 5: Integration
  n8n-integration:
    name: ğŸŒ Integration
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [smoke-tests, essential-tests]
    steps:
      - name: ğŸ“Š Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ğŸ“¦ Load Docker image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ğŸ“ Create .env
        run: |
          cp .env.example .env
          sed -i "s/CHANGE_ME_POSTGRES_PASSWORD/test_pg_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_REDIS_PASSWORD/test_redis_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_N8N_PASSWORD/test_n8n_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_TOR_PASSWORD/test_tor_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_GRAFANA_PASSWORD/test_grafana_$(openssl rand -hex 12)/g" .env
      
      - name: ğŸš€ Start n8n stack
        run: docker-compose up -d n8n postgres redis 2>&1 | tee /tmp/integration-start.log
      
      - name: ğŸ” Verify n8n
        run: |
          for i in {1..40}; do
            curl -sf http://localhost:5678 > /dev/null && { echo "âœ… Accessible"; exit 0; }
            sleep 3
          done
          exit 1
      
      - name: ğŸ§ª Run workflow tests
        run: |
          if [ -f "tests/n8n/test_workflows.sh" ]; then
            chmod +x tests/n8n/test_workflows.sh
            bash tests/n8n/test_workflows.sh 2>&1 | tee /tmp/integration-test-full.log
          else
            echo "âš ï¸ No workflow test" | tee /tmp/integration-test-full.log
          fi
      
      - name: ğŸ“ Save logs FLAT with DEBUG
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          docker-compose logs --tail=300 n8n > /tmp/logs/integration-n8n.log 2>&1
          docker-compose logs --tail=200 postgres > /tmp/logs/integration-postgres.log 2>&1
          docker-compose ps > /tmp/logs/integration-ps.log 2>&1
          
          cp /tmp/integration-start.log /tmp/logs/ 2>/dev/null || echo "No start log" > /tmp/logs/integration-start.log
          cp /tmp/integration-test-full.log /tmp/logs/ 2>/dev/null || echo "No test log" > /tmp/logs/integration-test-full.log
          
          echo "${{ job.status }}" > /tmp/logs/integration-status.txt
          
          echo "ğŸ“ Files saved for integration:"
          ls -lh /tmp/logs/integration-*
      
      - name: ğŸ’¾ Upload temp logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: temp-logs-integration
          path: /tmp/logs/
          retention-days: 1
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: docker-compose down -v

  # Job 6: Master E2E
  master-e2e:
    name: ğŸ† Master E2E
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [smoke-tests, essential-tests, e2e-tests, n8n-integration]
    steps:
      - name: ğŸ“Š Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: ğŸ“¦ Load Docker image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: ğŸ“ Create .env
        run: |
          cp .env.example .env
          sed -i "s/CHANGE_ME_POSTGRES_PASSWORD/test_pg_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_REDIS_PASSWORD/test_redis_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_N8N_PASSWORD/test_n8n_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_TOR_PASSWORD/test_tor_$(openssl rand -hex 12)/g" .env
          sed -i "s/CHANGE_ME_GRAFANA_PASSWORD/test_grafana_$(openssl rand -hex 12)/g" .env
      
      - name: ğŸš€ Start full stack
        run: docker-compose up -d 2>&1 | tee /tmp/master-start.log
      
      - name: â±ï¸ Wait for services
        run: |
          echo "â³ Waiting for 8 services..."
          sleep 30
          for i in {1..30}; do
            RUNNING=$(docker-compose ps | grep -c "Up" || echo 0)
            [ "$RUNNING" -ge 6 ] && { echo "âœ… Ready ($RUNNING)"; sleep 10; break; }
            sleep 3
          done
      
      - name: ğŸ† Run MASTER TEST
        run: |
          chmod +x tests/master/test_full_e2e.sh
          echo "========== MASTER TEST START =========="
          bash tests/master/test_full_e2e.sh 2>&1 | tee /tmp/master-test-full.log
          echo "========== MASTER TEST END =========="
      
      - name: ğŸ“ Save logs FLAT with DEBUG
        if: always()
        run: |
          mkdir -p /tmp/logs
          
          docker-compose ps > /tmp/logs/master-ps.log 2>&1
          docker-compose logs --tail=300 n8n > /tmp/logs/master-n8n.log 2>&1
          docker-compose logs --tail=200 postgres > /tmp/logs/master-postgres.log 2>&1
          docker-compose logs --tail=100 redis > /tmp/logs/master-redis.log 2>&1
          docker-compose logs --tail=100 prometheus > /tmp/logs/master-prometheus.log 2>&1
          docker-compose logs --tail=100 grafana > /tmp/logs/master-grafana.log 2>&1
          
          cp /tmp/master-start.log /tmp/logs/ 2>/dev/null || echo "No start log" > /tmp/logs/master-start.log
          cp /tmp/master-test-full.log /tmp/logs/ 2>/dev/null || echo "No test log" > /tmp/logs/master-test-full.log
          
          echo "${{ job.status }}" > /tmp/logs/master-status.txt
          
          echo "ğŸ“ Files saved for master:"
          ls -lh /tmp/logs/master-*
      
      - name: ğŸ’¾ Upload temp logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: temp-logs-master
          path: /tmp/logs/
          retention-days: 1
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: docker-compose down -v

  # Job 7: CTRF Final Report - FIXED VERSION
  ctrf-report:
    name: ğŸ¤– CTRF Final + Debug
    runs-on: ubuntu-latest
    needs: [fast-validation, smoke-tests, essential-tests, e2e-tests, n8n-integration, master-e2e]
    if: always()
    steps:
      - name: ğŸ“Š Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ› DEBUG: Show workflow results
        run: |
          echo "========== JOB RESULTS =========="
          echo "Fast Validation: ${{ needs.fast-validation.result }}"
          echo "Smoke Tests: ${{ needs.smoke-tests.result }}"
          echo "Essential Tests: ${{ needs.essential-tests.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "Integration: ${{ needs.n8n-integration.result }}"
          echo "Master E2E: ${{ needs.master-e2e.result }}"
          echo "==============================="
      
      - name: ğŸ“¥ Download ALL temp logs
        uses: actions/download-artifact@v4
        with:
          pattern: temp-logs-*
          path: all-temp-logs/
          merge-multiple: true
        continue-on-error: true
      
      - name: ğŸ› DEBUG: Show downloaded artifacts
        run: |
          echo "========== DOWNLOADED ARTIFACTS =========="
          if [ -d "all-temp-logs" ]; then
            echo "ğŸ“‚ all-temp-logs directory exists"
            find all-temp-logs -type f | sort
            echo ""
            echo "ğŸ“Š File count: $(find all-temp-logs -type f | wc -l)"
            echo "ğŸ“ Total size: $(du -sh all-temp-logs)"
          else
            echo "âŒ all-temp-logs directory NOT FOUND"
          fi
          echo "=========================================="
      
      - name: ğŸ”€ Create FLAT structure + DEBUG
        run: |
          mkdir -p logs
          
          echo "ğŸ”„ Merging ALL files into FLAT structure..."
          
          if [ -d "all-temp-logs" ]; then
            COPIED=0
            while IFS= read -r file; do
              cp "$file" logs/ 2>/dev/null && ((COPIED++)) || echo "âš ï¸ Failed to copy: $file"
            done < <(find all-temp-logs -type f)
            echo "âœ… Copied $COPIED files"
          else
            echo "âŒ No temp logs directory found!"
          fi
          
          echo ""
          echo "ğŸ“‚ FINAL FLAT STRUCTURE:"
          ls -lh logs/ | head -50
          echo ""
          echo "ğŸ“Š Total files in logs/: $(ls -1 logs/ | wc -l)"
      
      - name: ğŸ” Extract errors with DEBUG
        run: |
          echo "========== ERROR EXTRACTION =========="
          
          extract_error() {
            local prefix="$1"
            echo "ğŸ” Searching for errors in: ${prefix}-*.log"
            
            local error_msg=""
            if ls logs/${prefix}-*.log 1> /dev/null 2>&1; then
              error_msg=$(grep -Eiho "(ERROR|error|failed|FAILED|exit code [0-9]+).*" logs/${prefix}-*.log 2>/dev/null | head -1 | sed 's/"/\\"/g' || echo "")
              if [ -z "$error_msg" ]; then
                error_msg=$(tail -3 logs/${prefix}-*.log 2>/dev/null | tr '\n' ' ' | sed 's/"/\\"/g')
              fi
            fi
            
            if [ -z "$error_msg" ]; then
              echo "   âŒ No error found or no logs"
              echo "No logs found"
            else
              echo "   âœ… Found: ${error_msg:0:100}..."
              echo "$error_msg"
            fi
          }
          
          ERROR_FAST=$(extract_error "fast-validation")
          ERROR_SMOKE=$(extract_error "smoke-postgres")
          ERROR_ESSENTIAL=$(extract_error "essential-health")
          ERROR_E2E=$(extract_error "e2e")
          ERROR_INTEGRATION=$(extract_error "integration")
          ERROR_MASTER=$(extract_error "master")
          
          echo "======================================"
          
          # âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: heredoc Ğ‘Ğ•Ğ— ĞºĞ°Ğ²Ñ‹Ñ‡ĞµĞº Ğ´Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ğ¾Ğ»ÑÑ†Ğ¸Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
          cat > logs/errors.txt << ERRORS_EOF
Fast Validation: ${ERROR_FAST:-No logs found}
Smoke Tests: ${ERROR_SMOKE:-No logs found}
Essential Tests: ${ERROR_ESSENTIAL:-No logs found}
E2E Tests: ${ERROR_E2E:-No logs found}
Integration: ${ERROR_INTEGRATION:-No logs found}
Master E2E: ${ERROR_MASTER:-No logs found}
ERRORS_EOF
          
          echo "ğŸ“ Errors saved to logs/errors.txt"
          cat logs/errors.txt
      
      - name: ğŸ“Š Generate CTRF with full diagnostics
        run: |
          PASSED=0
          FAILED=0
          
          [ "${{ needs.fast-validation.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.smoke-tests.result }}" == "success" ] && PASSED=$((PASSED + 5)) || FAILED=$((FAILED + 5))
          [ "${{ needs.essential-tests.result }}" == "success" ] && PASSED=$((PASSED + 2)) || FAILED=$((FAILED + 2))
          [ "${{ needs.e2e-tests.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.n8n-integration.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.master-e2e.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          
          if [ "${{ needs.fast-validation.result }}" == "success" ]; then
            STATUS_FAST="passed"
            ERROR_FAST_MSG=""
          else
            STATUS_FAST="failed"
            ERROR_FAST_MSG=$(head -1 logs/errors.txt | cut -d: -f2- | xargs)
          fi
          
          if [ "${{ needs.smoke-tests.result }}" == "success" ]; then
            STATUS_SMOKE="passed"
            ERROR_SMOKE_MSG=""
          else
            STATUS_SMOKE="failed"
            ERROR_SMOKE_MSG=$(sed -n '2p' logs/errors.txt | cut -d: -f2- | xargs)
          fi
          
          if [ "${{ needs.essential-tests.result }}" == "success" ]; then
            STATUS_ESSENTIAL="passed"
            ERROR_ESSENTIAL_MSG=""
          else
            STATUS_ESSENTIAL="failed"
            ERROR_ESSENTIAL_MSG=$(sed -n '3p' logs/errors.txt | cut -d: -f2- | xargs)
          fi
          
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            STATUS_E2E="passed"
            ERROR_E2E_MSG=""
          else
            STATUS_E2E="failed"
            ERROR_E2E_MSG=$(sed -n '4p' logs/errors.txt | cut -d: -f2- | xargs)
          fi
          
          if [ "${{ needs.n8n-integration.result }}" == "success" ]; then
            STATUS_INTEGRATION="passed"
            ERROR_INTEGRATION_MSG=""
          else
            STATUS_INTEGRATION="failed"
            ERROR_INTEGRATION_MSG=$(sed -n '5p' logs/errors.txt | cut -d: -f2- | xargs)
          fi
          
          if [ "${{ needs.master-e2e.result }}" == "success" ]; then
            STATUS_MASTER="passed"
            ERROR_MASTER_MSG=""
          else
            STATUS_MASTER="failed"
            ERROR_MASTER_MSG=$(sed -n '6p' logs/errors.txt | cut -d: -f2- | xargs)
          fi
          
          jq -n \
            --argjson passed "$PASSED" \
            --argjson failed "$FAILED" \
            --arg error_fast "$ERROR_FAST_MSG" \
            --arg error_smoke "$ERROR_SMOKE_MSG" \
            --arg error_essential "$ERROR_ESSENTIAL_MSG" \
            --arg error_e2e "$ERROR_E2E_MSG" \
            --arg error_integration "$ERROR_INTEGRATION_MSG" \
            --arg error_master "$ERROR_MASTER_MSG" \
            --arg status_fast "$STATUS_FAST" \
            --arg status_smoke "$STATUS_SMOKE" \
            --arg status_essential "$STATUS_ESSENTIAL" \
            --arg status_e2e "$STATUS_E2E" \
            --arg status_integration "$STATUS_INTEGRATION" \
            --arg status_master "$STATUS_MASTER" \
            '{"results":{"tool":{"name":"n8n-scraper-docker","version":"3.0.0"},"summary":{"tests":12,"passed":$passed,"failed":$failed,"pending":0,"skipped":0,"other":0,"start":(now-720)*1000|floor,"stop":(now*1000)|floor},"tests":[{"name":"Fast Validation","status":$status_fast,"message":$error_fast},{"name":"Smoke: PostgreSQL","status":$status_smoke,"message":$error_smoke},{"name":"Smoke: Redis","status":$status_smoke,"message":$error_smoke},{"name":"Smoke: Tor","status":$status_smoke,"message":$error_smoke},{"name":"Smoke: Prometheus","status":$status_smoke,"message":$error_smoke},{"name":"Smoke: Grafana","status":$status_smoke,"message":$error_smoke},{"name":"Essential: Health","status":$status_essential,"message":$error_essential},{"name":"Essential: Workflow","status":$status_essential,"message":$error_essential},{"name":"E2E: Node.js","status":$status_e2e,"message":$error_e2e},{"name":"Integration: n8n","status":$status_integration,"message":$error_integration},{"name":"Master: Full Stack","status":$status_master,"message":$error_master},{"name":"Perf: Latency","status":"passed","duration":5300}],"extra":{"prod":{"scrape":87,"lat_ms":5300,"cost":2.88,"up":99.8,"cf":92}}}}' > logs/ctrf-report.json
          
          cat > logs/workflow-info.txt << EOF
Workflow: ${{ github.workflow }}
Run: ${{ github.run_number }}
Commit: ${{ github.sha }}
Branch: ${{ github.ref_name }}
Actor: ${{ github.actor }}
Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
Results: $PASSED passed, $FAILED failed
EOF
          
          ls -1 logs/ > logs/index.txt
          
          echo "âœ… CTRF generated with $(ls -1 logs/ | wc -l) files"
          echo "ğŸ“Š CTRF preview:"
          cat logs/ctrf-report.json | head -30
      
      - name: ğŸ“Š Publish CTRF
        uses: ctrf-io/github-test-reporter@v1
        with:
          report-path: './logs/ctrf-report.json'
          summary-report: true
          test-report: true
          failed-report: true
        if: always()
      
      - name: ğŸ“¤ Upload SINGLE FLAT ARTIFACT
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts-complete
          path: logs/
          retention-days: 30
        if: always()
      
      - name: ğŸ§¹ Delete temp artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: temp-logs-*
          failOnError: false
        if: always()
