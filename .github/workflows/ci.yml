name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
          persist-credentials: false
      
      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-lock.txt
          check-latest: true
      
      - name: Install dependencies (hardened)
        run: |
          pip install --upgrade pip
          pip install -r requirements-lock.txt
          pip check
        timeout-minutes: 10
        env:
          PIP_NO_CACHE_DIR: 1
          PIP_DISABLE_PIP_VERSION_CHECK: 1
      
      - name: Verify dependency versions
        run: |
          pip list --format=freeze > installed.txt
          echo "=== Installed packages ==="
          cat installed.txt
          
          # Compare with expected (detect unexpected packages)
          pip freeze > actual-freeze.txt
          echo "\n=== Checking for dependency drift ==="
          diff requirements-lock.txt actual-freeze.txt || echo "WARNING: Dependency mismatch detected"
      
      - name: Security audit dependencies
        run: |
          pip install pip-audit pytest-xdist
          pip-audit --desc --format json -o pip-audit-results.json || true
          pip-audit --desc || true
      
      - name: Upload dependency manifests
        uses: actions/upload-artifact@v4
        with:
          name: dependency-manifests
          path: |
            installed.txt
            actual-freeze.txt
            pip-audit-results.json
      
      - name: Run Python tests (optimized)
        run: |
          pytest tests/ \
            -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=term \
            --cov-report=html \
            --cov-fail-under=80 \
            --junitxml=pytest-results.xml \
            -n auto \
            --maxfail=3 \
            --tb=short
        timeout-minutes: 20
        continue-on-error: false
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: |
            pytest-results.xml
            htmlcov/
            coverage.xml
      
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          check-latest: true
          registry-url: 'https://registry.npmjs.org'
      
      - name: Verify Node installation (enhanced)
        run: |
          echo "=== Node.js Environment ==="
          node --version
          npm --version
          node -e "console.log('Node.js works: ' + process.version)"
          echo -e "\n=== npm Configuration ==="
          npm config get cache
          npm config get registry
          npm config list
          echo -e "\n=== Registry connectivity ==="
          npm ping
          echo -e "\n=== npm doctor ==="
          npm doctor || echo "WARNING: npm doctor found issues"
      
      - name: Validate package-lock.json
        run: |
          echo "=== Validating lockfile integrity ==="
          npm ls --json > /dev/null || echo "WARNING: Dependency tree has issues"
          jq '.lockfileVersion' package-lock.json
      
      - name: Install Node dependencies (hardened)
        run: npm ci --prefer-offline --no-audit
        timeout-minutes: 10
        env:
          NODE_ENV: production
          NPM_CONFIG_LOGLEVEL: warn
      
      - name: Verify Node installation integrity
        run: |
          echo "=== Installed packages ==="
          npm ls --depth=0
          echo -e "\n=== node_modules size ==="
          du -sh node_modules
          echo -e "\n=== Checking for vulnerabilities ==="
          npm audit --json > npm-audit-results.json || true
          npm audit
          echo -e "\n=== Listing outdated packages ==="
          npm outdated || true
      
      - name: Upload npm reports
        uses: actions/upload-artifact@v4
        with:
          name: npm-reports
          path: |
            npm-audit-results.json
            package-lock.json
      
      - name: Run npm audit (strict mode)
        run: |
          echo "=== npm audit (production dependencies) ==="
          npm audit --production --audit-level=moderate --json > npm-audit-prod.json || true
          npm audit --production --audit-level=high || true
          echo -e "\n=== Checking CRITICAL vulnerabilities ==="
          if npm audit --production --audit-level=critical > /dev/null 2>&1; then
            echo "✅ No CRITICAL vulnerabilities"
          else
            echo "❌ CRITICAL vulnerabilities found!"
            npm audit --production --audit-level=critical
            exit 1
          fi
          echo -e "\n=== Vulnerability summary ==="
          npm audit --production || true
        continue-on-error: false

      - name: Upload npm audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-detailed
          path: npm-audit-prod.json

      - name: Check for secrets leakage (hardened)
        uses: trufflesecurity/trufflehog@v3.82.13
        with:
          path: .
          scan_depth: 100
          redact: true
          fail: true
          extra_args: "--json --no-update --entropy=true --regex --max_depth=10"
        continue-on-error: false

      - name: Create trufflehog allowlist
        run: |
          cat > .trufflehog.yml << 'EOF'
          # Trufflehog configuration
          exclude:
            paths:
              - "**/*.md"
              - "**/test/**"
              - "**/*.example"
          EOF

      - name: Additional secrets scan (extended)
        run: |
          echo "=== Scanning for common secret patterns ==="
          grep -r -i "password\s*=\s*['\"].*['\"]" . --exclude-dir={node_modules,.git} || echo "No hardcoded passwords"
          grep -r -i "api[_-]key\s*=\s*['\"].*['\"]" . --exclude-dir={node_modules,.git} || echo "No API keys"
          grep -r -i "secret\s*=\s*['\"].*['\"]" . --exclude-dir={node_modules,.git} || echo "No secrets"
          find . -name "*.pem" -o -name "*.key" -o -name "id_rsa*" | grep -v node_modules || echo "No private keys"
          grep -r "AKIA[0-9A-Z]{16}" . --exclude-dir={node_modules,.git} && exit 1 || echo "No AWS keys"

      - name: Run JavaScript tests (optimized)
        run: |
          echo "=== Running Jest tests with coverage ==="
          npm test -- \
            --coverage \
            --coverageReporters=json \
            --coverageReporters=lcov \
            --coverageReporters=text \
            --ci \
            --maxWorkers=2 \
            --bail=3 \
            --json --outputFile=jest-results.json || true
          
          echo -e "\n=== Checking coverage threshold ==="
          npm test -- --coverage --coverageThreshold='{"global":{"branches":80,"functions":80,"lines":80,"statements":80}}'
        timeout-minutes: 15
        continue-on-error: false
        env:
          NODE_ENV: test
          CI: true

      - name: Upload Jest results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-results
          path: |
            jest-results.json
            coverage/
            coverage/lcov.info

      - name: Upload test coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: javascript
          name: codecov-js

      - name: Check for build artifacts
        id: check-artifacts
        run: |
          if [ -d "./dist" ]; then
            echo "artifacts_exist=true" >> $GITHUB_OUTPUT
            echo "artifact_path=./dist" >> $GITHUB_OUTPUT
          elif [ -d "./build" ]; then
            echo "artifacts_exist=true" >> $GITHUB_OUTPUT
            echo "artifact_path=./build" >> $GITHUB_OUTPUT
          elif [ -d "./out" ]; then
            echo "artifacts_exist=true" >> $GITHUB_OUTPUT
            echo "artifact_path=./out" >> $GITHUB_OUTPUT
          else
            echo "artifacts_exist=false" >> $GITHUB_OUTPUT
            echo "WARNING: No build artifacts found"
          fi

      - name: Upload build artifacts
        if: steps.check-artifacts.outputs.artifacts_exist == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ${{ steps.check-artifacts.outputs.artifact_path }}
          retention-days: 30
          compression-level: 6

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
            coverage/
          retention-days: 14

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
      
      - name: SLSA Provenance
        uses: slsa-framework/github-actions-build@v2
      
      - name: Slack notification on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: '#ci-alerts'
          SLACK_COLOR: '#ef2d56'

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Run CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python, javascript
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'
