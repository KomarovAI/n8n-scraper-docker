name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write
  attestations: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      ...
      - name: Slack notification on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2.3.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: '#ci-alerts'
          SLACK_COLOR: 'danger'
          SLACK_TITLE: 'CI Pipeline Failed'
          SLACK_MESSAGE: |
            Build failed for ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_FOOTER: 'CI/CD Pipeline'
          MSG_MINIMAL: 'actions url'
        continue-on-error: true
        timeout-minutes: 2
      - name: Email notification on failure (fallback)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'CI Failed: ${{ github.repository }}'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: CI/CD Pipeline
          body: |
            Build failed for ${{ github.repository }}
            View: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        continue-on-error: true
  owasp-dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'n8n-scraper-workflow'
          path: '.'
          format: 'ALL'
          args: --enableRetired --enableExperimental --failOnCVSS 7
        timeout-minutes: 20
      - name: Upload OWASP results
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check
          path: reports/
  dependency-diff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Dependency diff analysis
        run: |
          git show HEAD^:requirements-lock.txt > old-requirements.txt || true
          diff old-requirements.txt requirements-lock.txt > python-deps-diff.txt || true
          git show HEAD^:package-lock.json > old-package-lock.json || true
          npm diff --diff=old-package-lock.json --diff-name-only > node-deps-diff.txt || true
          echo "=== Changed Python packages ==="
          cat python-deps-diff.txt || true
          echo -e "\n=== Changed Node packages ==="
          cat node-deps-diff.txt || true
      - name: Upload dependency diff
        uses: actions/upload-artifact@v4
        with:
          name: dependency-diff
          path: |
            python-deps-diff.txt
            node-deps-diff.txt
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v5
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: n8n-scraper
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
      - name: Deploy to Kubernetes
        run: |
          aws eks update-kubeconfig --name production-cluster
          kubectl set image deployment/n8n-scraper \
            n8n-scraper=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          kubectl rollout status deployment/n8n-scraper
      - name: Run smoke tests
        run: |
          curl -f https://production.example.com/health || exit 1
      - name: Notify deployment success
        uses: rtCamp/action-slack-notify@v2.3.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: '#deployments'
          SLACK_COLOR: 'good'
          SLACK_TITLE: 'Deployment Successful'
          SLACK_MESSAGE: 'Deployed ${{ github.sha }} to production'
  production-secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Scan production logs for secrets
        run: |
          aws logs tail /aws/ecs/production --since 24h > prod-logs.txt || true
          trufflehog filesystem prod-logs.txt --json --fail --no-update
      - name: Scan production configs
        run: |
          kubectl get configmaps -o yaml > configs.yaml || true
          kubectl get secrets -o yaml > secrets.yaml || true
          grep -r "password" configs.yaml && exit 1 || echo "OK"
      - name: Runtime secret detection
        run: |
          kubectl exec deployment/n8n-scraper -- env | \
            grep -E "(KEY|SECRET|PASSWORD|TOKEN)" || echo "No exposed secrets"
  secrets-rotation:
    runs-on: ubuntu-latest
    steps:
      - name: Check AWS secrets age
        run: |
          aws secretsmanager list-secrets \
            --query 'SecretList[?LastChangedDate<`2024-11-01`]' \
            --output table || true
      - name: Alert on old secrets
        uses: rtCamp/action-slack-notify@v2.3.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: 'WARNING: Secrets rotation required!'
