name: 1 Infrastructure Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: infra-check-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  fast-validation:
    name: Build and Security
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      start_time: ${{ steps.timer.outputs.start_time }}
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
      
      - name: Security scan
        run: docker run --rm -v "$(pwd)":/path trufflesecurity/trufflehog:latest filesystem /path --only-verified --fail || echo "No verified secrets"
        continue-on-error: true
      
      - name: Build and export
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.n8n-enhanced
          tags: n8n-enhanced:test
          outputs: type=docker,dest=/tmp/n8n-enhanced.tar
          cache-from: |
            type=gha,scope=buildkit-n8n-${{ github.ref_name }}
            type=gha,scope=buildkit-n8n-main
          cache-to: type=gha,mode=max,scope=buildkit-n8n-${{ github.ref_name }}
          build-args: BUILDKIT_INLINE_CACHE=1
      
      - name: Compress image
        run: gzip -1 /tmp/n8n-enhanced.tar
      
      - name: Upload image
        uses: actions/upload-artifact@v5
        with:
          name: n8n-enhanced-image
          path: /tmp/n8n-enhanced.tar.gz
          retention-days: 1
          compression-level: 0
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          IMAGE_SIZE=$(stat -c%s /tmp/n8n-enhanced.tar.gz 2>/dev/null | awk '{print int($1/1024/1024)}' || echo 0)
          echo "Build: ${DURATION}s, Size: ${IMAGE_SIZE}MB" | tee /tmp/logs/build.log
          jq -n --arg job "build" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --argjson image_size "$IMAGE_SIZE" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, image_size_mb: $image_size}' > /tmp/logs/build-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: infra-logs-build
          path: /tmp/logs/
          retention-days: 1

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: fast-validation
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "PostgreSQL", slug: "postgres", script: "tests/smoke/test_postgres_redis.sh", services: "postgres" }
          - { name: "Redis", slug: "redis", script: "tests/smoke/test_postgres_redis.sh", services: "redis" }
          - { name: "Tor", slug: "tor", script: "tests/smoke/test_tor.sh", services: "tor" }
          - { name: "Prometheus", slug: "prometheus", script: "tests/smoke/test_monitoring.sh", services: "prometheus" }
          - { name: "Grafana", slug: "grafana", script: "tests/smoke/test_monitoring.sh", services: "grafana" }
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Download image
        uses: actions/download-artifact@v6
        with:
          name: n8n-enhanced-image
          path: /tmp
      
      - name: Load image
        run: docker load < /tmp/n8n-enhanced.tar.gz
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          # Database & Cache
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          
          # n8n Authentication
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          
          # Tor Control
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          
          # Monitoring
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          
          # Optional API Keys
          FIRECRAWL_API_KEY=
          JINA_API_KEY=
          EOF
      
      - name: Start service
        run: docker compose up -d ${{ matrix.test.services }}
      
      - name: Wait for service
        run: for i in {1..30}; do docker compose ps | grep -q "Up" && { sleep 5; break; }; sleep 2; done
      
      - name: Run test
        id: test
        run: |
          chmod +x ${{ matrix.test.script }} || true
          bash ${{ matrix.test.script }} 2>&1 | tee /tmp/smoke-${{ matrix.test.slug }}-test.log
        continue-on-error: true
      
      - name: Save metrics
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          cp /tmp/smoke-${{ matrix.test.slug }}-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/smoke-${{ matrix.test.slug }}-test.log
          jq -n --arg job "smoke-${{ matrix.test.slug }}" --arg test_name "${{ matrix.test.name }}" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, test_name: $test_name, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/smoke-${{ matrix.test.slug }}-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: infra-logs-smoke-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  summary:
    name: Infrastructure Summary
    runs-on: ubuntu-latest
    needs: [fast-validation, smoke-tests]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Download logs
        uses: actions/download-artifact@v6
        with:
          pattern: infra-logs-*
          path: all-logs/
          merge-multiple: true
        continue-on-error: true
      
      - name: Generate summary
        run: |
          mkdir -p logs
          [ -d "all-logs" ] && find all-logs -type f -exec cp {} logs/ \;
          
          PASSED=0
          FAILED=0
          [ "${{ needs.fast-validation.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.smoke-tests.result }}" == "success" ] && PASSED=$((PASSED + 5)) || FAILED=$((FAILED + 5))
          
          cat > logs/infra-summary.md << EOF
          # Infrastructure Check Summary
          
          **Build**: ${{ needs.fast-validation.result }}
          **Smoke Tests**: ${{ needs.smoke-tests.result }}
          
          **Total**: ${PASSED} passed, ${FAILED} failed
          **Duration**: ${{ needs.fast-validation.outputs.duration }}s
          EOF
          
          cat logs/infra-summary.md
      
      - name: Upload summary
        uses: actions/upload-artifact@v5
        with:
          name: infrastructure-check-summary
          path: logs/
          retention-days: 7
        if: always()
      
      - name: Cleanup temp logs
        uses: geekyeggo/delete-artifact@v5
        with:
          name: infra-logs-*
          failOnError: false
        if: always()

  # NEW: Trigger n8n validation workflow after infrastructure check succeeds
  trigger-validation:
    name: Trigger n8n Validation
    needs: [fast-validation, smoke-tests, summary]
    # Only trigger if infrastructure check succeeded
    if: |
      needs.fast-validation.result == 'success' &&
      needs.smoke-tests.result == 'success'
    uses: ./.github/workflows/2-n8n-validation.yaml
    secrets: inherit
