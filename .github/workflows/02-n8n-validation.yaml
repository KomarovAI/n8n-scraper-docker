name: 2 n8n Validation (Persistent API Key)

on:
  # ðŸ”¥ ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð™ Ð—ÐÐŸÐ£Ð¡Ðš
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_cleanup:
        description: 'ðŸ—‘ï¸ Skip cleanup (keep containers running)'
        required: false
        type: boolean
        default: false
  
  # Ð’Ñ‹Ð·Ð¾Ð² Ð¸Ð· Ð´Ñ€ÑƒÐ³Ð¸Ñ… workflow
  workflow_call:

concurrency:
  group: n8n-validation-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  LOGS_DIR: /tmp/validation-logs
  COMPOSE_PROJECT_NAME: n8n-ci-${{ github.run_id }}
  SKIP_CLEANUP: ${{ inputs.skip_cleanup || false }}

jobs:
  n8n-workflow-tests:
    name: Workflow Tests
    runs-on: self-hosted
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
      
      - name: ðŸ§¹ Preflight cleanup
        run: |
          echo "ðŸ” Cleaning up leftover containers..."
          docker ps -aq --filter "name=n8n-" | xargs -r docker rm -f || true
          docker volume ls -q --filter "name=n8n-scraper-docker" | xargs -r docker volume rm || true
          docker network prune -f || true
          echo "âœ… Cleanup complete"
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“ Create .env
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: ðŸ­ Build image
        run: |
          docker build -t n8n-enhanced:test -f Dockerfile.n8n-enhanced --build-arg BUILDKIT_INLINE_CACHE=1 .
      
      - name: ðŸš€ Start n8n stack
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d postgres redis
          sleep 12
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d n8n
      
      - name: â³ Wait for n8n readiness
        run: |
          for i in {1..90}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
              echo "âœ… n8n process ready"
              break
            fi
            [ $i -eq 90 ] && echo "âŒ Timeout" && exit 1
            sleep 1
          done
          
          for i in {1..60}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5678/healthz/readiness)
            if [ "$CODE" == "200" ]; then
              echo "âœ… n8n fully ready"
              break
            fi
            [ $i -eq 60 ] && echo "âŒ Readiness timeout" && exit 1
            sleep 2
          done
          
          sleep 10
          echo "âœ… Ready for workflow tests"
      
      - name: ðŸ”§ Setup owner
        env:
          N8N_URL: "http://localhost:5678"
          N8N_USER: ${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD: ${{ secrets.N8N_PASSWORD_CI }}
        run: |
          chmod +x scripts/setup-n8n-owner.sh
          bash scripts/setup-n8n-owner.sh
        timeout-minutes: 3
      
      # =====================================================================
      # PERSISTENT API KEY ONLY
      # =====================================================================
      - name: ðŸ”‘ Validate API Key
        id: api_key
        run: |
          if [ -z "${{ secrets.N8N_API }}" ]; then
            echo "âŒ N8N_API secret is required!"
            echo ""
            echo "Setup instructions:"
            echo "1. Create API key in n8n UI:"
            echo "   - Open: http://localhost:5678"
            echo "   - Go to: Settings â†’ n8n API â†’ Create API key"
            echo "   - Label: CI Persistent Key"
            echo "   - Expiration: Never (or far future date)"
            echo "   - Copy the generated key"
            echo ""
            echo "2. Add to GitHub Secrets:"
            echo "   gh secret set N8N_API --body 'n8n_api_xxxxx'"
            echo ""
            echo "3. Re-run this workflow"
            exit 1
          fi
          
          echo "âœ… Using persistent API key"
          echo "N8N_API_KEY=${{ secrets.N8N_API }}" >> $GITHUB_ENV
        timeout-minutes: 1
      
      - name: ðŸ“¦ Initialize workflows
        env:
          N8N_URL: "http://localhost:5678"
          N8N_API_KEY: ${{ env.N8N_API_KEY }}
          WORKFLOWS_DIR: "workflows"
        run: |
          chmod +x scripts/init-workflows-api-key.sh
          bash scripts/init-workflows-api-key.sh
        timeout-minutes: 5
      
      - name: ðŸ§ª Test workflows
        id: test
        env:
          N8N_URL: "http://localhost:5678"
          WEBHOOK_PATH: "/webhook/scrape"
          TEST_TIMEOUT: "30"
          REPORT_FILE: "${{ env.LOGS_DIR }}/workflow-results.json"
        run: |
          chmod +x scripts/test-n8n-workflows.sh
          mkdir -p ${{ env.LOGS_DIR }}
          bash scripts/test-n8n-workflows.sh
        timeout-minutes: 8
      
      - name: ðŸ“Š Parse results
        id: parse
        if: always()
        run: |
          REPORT="${{ env.LOGS_DIR }}/workflow-results.json"
          if [ -f "$REPORT" ]; then
            echo "PASSED=$(jq -r '.summary.passed' "$REPORT")" >> $GITHUB_OUTPUT
            echo "FAILED=$(jq -r '.summary.failed' "$REPORT")" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=$(jq -r '.summary.success_rate' "$REPORT")" >> $GITHUB_OUTPUT
          else
            echo "PASSED=0" >> $GITHUB_OUTPUT
            echo "FAILED=0" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=0" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: workflow-results
          path: ${{ env.LOGS_DIR }}/*
          retention-days: 3
      
      - name: ðŸ§¹ Cleanup
        if: always() && env.SKIP_CLEANUP == 'false'
        timeout-minutes: 5
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v --remove-orphans || true
          rm -rf ${{ env.LOGS_DIR }}