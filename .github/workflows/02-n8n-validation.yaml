name: 2 n8n Validation (Hybrid Mode)

on:
  # ðŸ”¥ ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð™ Ð—ÐÐŸÐ£Ð¡Ðš (Ephemeral Ñ€ÐµÐ¶Ð¸Ð¼)
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  
  # Manual trigger Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ð°
  workflow_dispatch:
    inputs:
      use_persistent_n8n:
        description: 'ðŸ”§ Use persistent n8n (for debugging only)'
        required: false
        type: boolean
        default: false
      skip_cleanup:
        description: 'ðŸ—‘ï¸ Skip cleanup (keep containers running)'
        required: false
        type: boolean
        default: false
  
  # Ð’Ñ‹Ð·Ð¾Ð² Ð¸Ð· Ð´Ñ€ÑƒÐ³Ð¸Ñ… workflow
  workflow_call:
    inputs:
      use_persistent_n8n:
        description: 'Use persistent n8n'
        required: false
        type: boolean
        default: false

concurrency:
  group: n8n-validation-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  LOGS_DIR: /tmp/validation-logs
  COMPOSE_PROJECT_NAME: n8n-ci-${{ github.run_id }}
  # âœ… HYBRID MODE: Ephemeral (default) or Persistent (manual debug)
  USE_PERSISTENT_N8N: ${{ inputs.use_persistent_n8n || false }}
  SKIP_CLEANUP: ${{ inputs.skip_cleanup || false }}

jobs:
  n8n-workflow-tests:
    name: Workflow Tests (${{ inputs.use_persistent_n8n && 'Persistent' || 'Ephemeral' }})
    runs-on: self-hosted
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
      
      # =====================================================================
      # CONDITIONAL: Ephemeral mode full setup
      # =====================================================================
      - name: ðŸ§¹ Preflight cleanup (Ephemeral mode)
        if: env.USE_PERSISTENT_N8N == 'false'
        run: |
          echo "ðŸ” Cleaning up leftover containers..."
          docker ps -aq --filter "name=n8n-" | xargs -r docker rm -f || true
          docker volume ls -q --filter "name=n8n-scraper-docker" | xargs -r docker volume rm || true
          docker network prune -f || true
          echo "âœ… Cleanup complete"
      
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“ Create .env (Ephemeral mode)
        if: env.USE_PERSISTENT_N8N == 'false'
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: ðŸ­ Build image (Ephemeral mode)
        if: env.USE_PERSISTENT_N8N == 'false'
        run: |
          docker build -t n8n-enhanced:test -f Dockerfile.n8n-enhanced --build-arg BUILDKIT_INLINE_CACHE=1 .
      
      - name: ðŸš€ Start n8n stack (Ephemeral mode)
        if: env.USE_PERSISTENT_N8N == 'false'
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d postgres redis
          sleep 12
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d n8n
      
      # =====================================================================
      # CONDITIONAL: Persistent mode validation
      # =====================================================================
      - name: ðŸ” Check persistent n8n (Persistent mode)
        if: env.USE_PERSISTENT_N8N == 'true'
        run: |
          if ! curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
            echo "âŒ Persistent n8n not running!"
            echo "Run: bash setup-persistent-n8n.sh"
            exit 1
          fi
          echo "âœ… Connected to persistent n8n"
      
      # =====================================================================
      # UNIVERSAL: Wait for readiness
      # =====================================================================
      - name: â³ Wait for n8n readiness
        run: |
          for i in {1..90}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
              echo "âœ… n8n process ready"
              break
            fi
            [ $i -eq 90 ] && echo "âŒ Timeout" && exit 1
            sleep 1
          done
          
          for i in {1..60}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5678/healthz/readiness)
            if [ "$CODE" == "200" ]; then
              echo "âœ… n8n fully ready"
              break
            fi
            [ $i -eq 60 ] && echo "âŒ Readiness timeout" && exit 1
            sleep 2
          done
          
          sleep 10
          echo "âœ… Ready for workflow tests"
      
      # =====================================================================
      # CONDITIONAL: Setup owner (Ephemeral mode only)
      # =====================================================================
      - name: ðŸ”§ Setup owner (Ephemeral mode)
        if: env.USE_PERSISTENT_N8N == 'false'
        env:
          N8N_URL: "http://localhost:5678"
          N8N_USER: ${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD: ${{ secrets.N8N_PASSWORD_CI }}
        run: |
          chmod +x scripts/setup-n8n-owner.sh
          bash scripts/setup-n8n-owner.sh
        timeout-minutes: 3
      
      # =====================================================================
      # HYBRID: API Key handling
      # =====================================================================
      - name: ðŸ”‘ Setup API Key
        id: api_key
        env:
          N8N_URL: "http://localhost:5678"
          N8N_USER: ${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD: ${{ secrets.N8N_PASSWORD_CI }}
          N8N_API_SECRET: ${{ secrets.N8N_API }}
          MODE: ${{ env.USE_PERSISTENT_N8N }}
        run: |
          # Cleanup Ð½Ð° exit
          trap "rm -f /tmp/n8n-cookies.txt" EXIT
          
          if [ "$MODE" == "true" ]; then
            # PERSISTENT: Use existing key
            if [ -z "$N8N_API_SECRET" ]; then
              echo "âŒ N8N_API secret required!"
              exit 1
            fi
            echo "âœ… Using persistent API key"
            echo "N8N_API_KEY=$N8N_API_SECRET" >> $GITHUB_ENV
          else
            # EPHEMERAL: Auto-generate
            echo "ðŸ”‘ Generating temporary API key..."
            
            # Wait for owner auth sync (timing issue fix)
            echo "â³ Waiting 5s for owner auth synchronization..."
            sleep 5
            
            # Login with retry
            echo "ðŸ” Logging in to n8n (with retry)..."
            LOGIN_SUCCESS=false
            
            for i in {1..5}; do
              echo "  Attempt $i/5..."
              
              LOGIN_RESPONSE=$(curl --connect-timeout 5 --max-time 15 \
                -s -c /tmp/n8n-cookies.txt \
                -X POST "$N8N_URL/rest/login" \
                -H "Content-Type: application/json" \
                -d "{\"email\": \"$N8N_USER\", \"password\": \"$N8N_PASSWORD\"}")
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ¿ÐµÑ…Ð° login
              if echo "$LOGIN_RESPONSE" | grep -qi '"id"'; then
                LOGIN_SUCCESS=true
                echo "  âœ… Login successful!"
                break
              fi
              
              if [ $i -lt 5 ]; then
                echo "  âš ï¸ Login failed, retrying in 3s..."
                echo "  Response preview: ${LOGIN_RESPONSE:0:200}"
                sleep 3
              fi
            done
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
            if [ "$LOGIN_SUCCESS" = false ]; then
              echo "âŒ Login failed after 5 attempts"
              echo "Final response: ${LOGIN_RESPONSE:0:500}"
              exit 1
            fi
            
            # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ cookie Ñ„Ð°Ð¹Ð»Ð°
            if [ ! -f "/tmp/n8n-cookies.txt" ] || [ ! -s "/tmp/n8n-cookies.txt" ]; then
              echo "âŒ Cookie file not created or empty!"
              exit 1
            fi
            
            # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ cookie
            if ! grep -q "n8n-auth" /tmp/n8n-cookies.txt; then
              echo "âš ï¸ Warning: n8n-auth cookie not found in file"
            fi
            
            echo "âœ… Session cookie saved"
            
            # Generate API key
            echo "ðŸ”‘ Creating API key..."
            API_RESPONSE=$(curl --connect-timeout 5 --max-time 15 \
              -s -b /tmp/n8n-cookies.txt \
              -X POST "$N8N_URL/rest/api-keys" \
              -H "Content-Type: application/json" \
              -d '{"label": "CI Ephemeral Key"}')
            
            API_KEY=$(echo "$API_RESPONSE" | jq -r '.apiKey')
            
            if [ "$API_KEY" != "null" ] && [ -n "$API_KEY" ]; then
              echo "âœ… Generated: ${API_KEY:0:20}..."
              echo "N8N_API_KEY=$API_KEY" >> $GITHUB_ENV
            else
              echo "âŒ Failed to generate API key"
              echo "Response: ${API_RESPONSE:0:500}"
              exit 1
            fi
            
            # Cookie cleanup (trap ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½)
          fi
        timeout-minutes: 2
      
      - name: ðŸ“¦ Initialize workflows
        env:
          N8N_URL: "http://localhost:5678"
          N8N_API_KEY: ${{ env.N8N_API_KEY }}
          WORKFLOWS_DIR: "workflows"
        run: |
          chmod +x scripts/init-workflows-api-key.sh
          bash scripts/init-workflows-api-key.sh
        timeout-minutes: 5
      
      - name: ðŸ§ª Test workflows
        id: test
        env:
          N8N_URL: "http://localhost:5678"
          WEBHOOK_PATH: "/webhook/scrape"
          TEST_TIMEOUT: "30"
          REPORT_FILE: "${{ env.LOGS_DIR }}/workflow-results.json"
        run: |
          chmod +x scripts/test-n8n-workflows.sh
          mkdir -p ${{ env.LOGS_DIR }}
          bash scripts/test-n8n-workflows.sh
        timeout-minutes: 8
      
      - name: ðŸ“Š Parse results
        id: parse
        if: always()
        run: |
          REPORT="${{ env.LOGS_DIR }}/workflow-results.json"
          if [ -f "$REPORT" ]; then
            echo "PASSED=$(jq -r '.summary.passed' "$REPORT")" >> $GITHUB_OUTPUT
            echo "FAILED=$(jq -r '.summary.failed' "$REPORT")" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=$(jq -r '.summary.success_rate' "$REPORT")" >> $GITHUB_OUTPUT
          else
            echo "PASSED=0" >> $GITHUB_OUTPUT
            echo "FAILED=0" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=0" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: workflow-results
          path: ${{ env.LOGS_DIR }}/*
          retention-days: 3
      
      # =====================================================================
      # CONDITIONAL: Cleanup (Ephemeral mode only)
      # =====================================================================
      - name: ðŸ§¹ Cleanup (Ephemeral mode)
        if: always() && env.USE_PERSISTENT_N8N == 'false' && env.SKIP_CLEANUP == 'false'
        timeout-minutes: 5
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v --remove-orphans || true
          rm -rf ${{ env.LOGS_DIR }}