name: 2 n8n Validation (Hybrid Mode)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'ðŸ”„ CI Mode'
        required: false
        type: choice
        options:
          - auto
          - persistent
          - ephemeral
        default: auto
      skip_cleanup:
        description: 'ðŸ—‘ï¸ Skip cleanup'
        required: false
        type: boolean
        default: false
  
  workflow_call:

concurrency:
  group: n8n-validation-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  LOGS_DIR: /tmp/validation-logs
  COMPOSE_PROJECT_NAME: n8n-ci-${{ github.run_id }}
  SKIP_CLEANUP: ${{ inputs.skip_cleanup || false }}
  # ðŸŽ¯ Hybrid Mode Configuration
  CI_MODE: ${{ inputs.mode || 'auto' }}
  PERSISTENT_N8N_URL: "http://192.168.0.105:5678"
  EPHEMERAL_N8N_URL: "http://localhost:5678"

jobs:
  n8n-workflow-tests:
    name: Workflow Tests (Hybrid)
    runs-on: self-hosted
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
      
      # =====================================================================
      # STEP 1: Determine CI Mode (Auto-detect or Manual)
      # =====================================================================
      - name: ðŸŽ¯ Determine CI Mode
        id: mode
        run: |
          echo "ðŸ” Detecting optimal CI mode..."
          
          MODE="${{ env.CI_MODE }}"
          
          # Auto-detection logic
          if [ "$MODE" == "auto" ]; then
            # Check if persistent n8n is running
            if curl -sf "$PERSISTENT_N8N_URL/healthz" > /dev/null 2>&1; then
              echo "âœ… Persistent n8n detected at $PERSISTENT_N8N_URL"
              MODE="persistent"
            else
              echo "âš ï¸  No persistent n8n found, using ephemeral mode"
              MODE="ephemeral"
            fi
          fi
          
          # Branch-based recommendation
          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "$MODE" == "ephemeral" ]; then
            echo "ðŸ’¡ Recommendation: Use persistent mode for main branch"
            echo "   Run: gh workflow run '2 n8n Validation (Hybrid Mode)' --field mode=persistent"
          fi
          
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Using CI Mode: $MODE"
      
      # =====================================================================
      # STEP 2: Persistent Mode (if persistent n8n exists)
      # =====================================================================
      - name: ðŸŸ¢ Persistent Mode Setup
        if: steps.mode.outputs.mode == 'persistent'
        id: persistent
        run: |
          echo "ðŸŸ¢ Using Persistent n8n Instance"
          echo "   URL: $PERSISTENT_N8N_URL"
          
          # Validate persistent instance health
          for i in {1..10}; do
            if curl -sf "$PERSISTENT_N8N_URL/healthz" > /dev/null 2>&1; then
              echo "âœ… Persistent n8n is healthy"
              break
            fi
            [ $i -eq 10 ] && echo "âŒ Persistent n8n not responding" && exit 1
            sleep 2
          done
          
          # Validate API key
          if [ -z "${{ secrets.N8N_API }}" ]; then
            echo "âŒ N8N_API secret required for persistent mode!"
            echo ""
            echo "Setup:"
            echo "1. Open: $PERSISTENT_N8N_URL"
            echo "2. Settings â†’ n8n API â†’ Create API key"
            echo "3. gh secret set N8N_API --body 'n8n_api_xxxxx'"
            exit 1
          fi
          
          echo "N8N_URL=$PERSISTENT_N8N_URL" >> $GITHUB_ENV
          echo "N8N_API_KEY=${{ secrets.N8N_API }}" >> $GITHUB_ENV
          echo "USING_PERSISTENT=true" >> $GITHUB_ENV
          echo "âœ… Persistent mode configured"
      
      # =====================================================================
      # STEP 3: Ephemeral Mode (spin up temporary instance)
      # =====================================================================
      - name: ðŸ”µ Ephemeral Mode Setup
        if: steps.mode.outputs.mode == 'ephemeral'
        id: ephemeral
        run: |
          echo "ðŸ”µ Using Ephemeral n8n Instance"
          echo "   Spinning up fresh instance..."
          
          # Cleanup leftover containers
          echo "ðŸ§¹ Cleaning up..."
          docker ps -aq --filter "name=n8n-" | xargs -r docker rm -f || true
          docker volume ls -q --filter "name=n8n-scraper-docker" | xargs -r docker volume rm || true
          docker network prune -f || true
          
          # Create .env
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
          
          # Build image
          docker build -t n8n-enhanced:test -f Dockerfile.n8n-enhanced --build-arg BUILDKIT_INLINE_CACHE=1 .
          
          # Start stack
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d postgres redis
          sleep 12
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d n8n
          
          # Wait for readiness
          echo "â³ Waiting for n8n readiness..."
          for i in {1..90}; do
            if curl -sf "$EPHEMERAL_N8N_URL/healthz" > /dev/null 2>&1; then
              echo "âœ… n8n process ready"
              break
            fi
            [ $i -eq 90 ] && echo "âŒ Timeout" && exit 1
            sleep 1
          done
          
          for i in {1..60}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$EPHEMERAL_N8N_URL/healthz/readiness")
            if [ "$CODE" == "200" ]; then
              echo "âœ… n8n fully ready"
              break
            fi
            [ $i -eq 60 ] && echo "âŒ Readiness timeout" && exit 1
            sleep 2
          done
          
          sleep 10
          
          echo "N8N_URL=$EPHEMERAL_N8N_URL" >> $GITHUB_ENV
          echo "USING_PERSISTENT=false" >> $GITHUB_ENV
          echo "âœ… Ephemeral instance ready"
      
      # =====================================================================
      # STEP 4: Setup Owner (Ephemeral only)
      # =====================================================================
      - name: ðŸ”§ Setup Owner Account
        if: env.USING_PERSISTENT == 'false'
        env:
          N8N_USER: ${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD: ${{ secrets.N8N_PASSWORD_CI }}
        run: |
          chmod +x scripts/setup-n8n-owner.sh
          bash scripts/setup-n8n-owner.sh
        timeout-minutes: 3
      
      # =====================================================================
      # STEP 5: Generate API Key (Ephemeral only)
      # =====================================================================
      - name: ðŸ”‘ Generate Ephemeral API Key
        if: env.USING_PERSISTENT == 'false'
        id: ephemeral_key
        run: |
          echo "ðŸ”‘ Generating ephemeral API key..."
          
          # Login and get cookie
          COOKIE=$(curl -c - -X POST "$N8N_URL/rest/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"${{ secrets.N8N_USER_CI }}","password":"${{ secrets.N8N_PASSWORD_CI }}"}' \
            2>/dev/null | grep -oP 'n8n-auth\s+\K[^\s]+')
          
          if [ -z "$COOKIE" ]; then
            echo "âŒ Login failed"
            exit 1
          fi
          
          # Create API key
          API_KEY=$(curl -X POST "$N8N_URL/rest/api-keys" \
            -H "Cookie: n8n-auth=$COOKIE" \
            -H "Content-Type: application/json" \
            -d '{"label":"CI Ephemeral Key"}' \
            2>/dev/null | jq -r '.data.apiKey')
          
          if [ -z "$API_KEY" ] || [ "$API_KEY" == "null" ]; then
            echo "âŒ API key generation failed"
            exit 1
          fi
          
          echo "N8N_API_KEY=$API_KEY" >> $GITHUB_ENV
          echo "âœ… API key generated (${#API_KEY} chars)"
        timeout-minutes: 2
      
      # =====================================================================
      # STEP 6: Import Workflows (Both modes)
      # =====================================================================
      - name: ðŸ“¦ Import Workflows
        env:
          WORKFLOWS_DIR: "workflows"
        run: |
          echo "ðŸ“¦ Importing workflows from $WORKFLOWS_DIR..."
          chmod +x scripts/init-workflows-api-key.sh
          bash scripts/init-workflows-api-key.sh
        timeout-minutes: 5
      
      # =====================================================================
      # STEP 7: Test Workflows (Both modes)
      # =====================================================================
      - name: ðŸ§ª Test Workflows
        id: test
        env:
          WEBHOOK_PATH: "/webhook/scrape"
          TEST_TIMEOUT: "30"
          REPORT_FILE: "${{ env.LOGS_DIR }}/workflow-results.json"
        run: |
          chmod +x scripts/test-n8n-workflows.sh
          mkdir -p ${{ env.LOGS_DIR }}
          bash scripts/test-n8n-workflows.sh
        timeout-minutes: 8
      
      # =====================================================================
      # STEP 8: Parse Results
      # =====================================================================
      - name: ðŸ“Š Parse Results
        id: parse
        if: always()
        run: |
          REPORT="${{ env.LOGS_DIR }}/workflow-results.json"
          if [ -f "$REPORT" ]; then
            echo "PASSED=$(jq -r '.summary.passed' "$REPORT")" >> $GITHUB_OUTPUT
            echo "FAILED=$(jq -r '.summary.failed' "$REPORT")" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=$(jq -r '.summary.success_rate' "$REPORT")" >> $GITHUB_OUTPUT
          else
            echo "PASSED=0" >> $GITHUB_OUTPUT
            echo "FAILED=0" >> $GITHUB_OUTPUT
            echo "SUCCESS_RATE=0" >> $GITHUB_OUTPUT
          fi
      
      # =====================================================================
      # STEP 9: Upload Artifacts
      # =====================================================================
      - name: ðŸ“¤ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: workflow-results-${{ steps.mode.outputs.mode }}
          path: ${{ env.LOGS_DIR }}/*
          retention-days: 3
      
      # =====================================================================
      # STEP 10: Cleanup (Ephemeral only)
      # =====================================================================
      - name: ðŸ§¹ Cleanup Ephemeral Instance
        if: always() && env.USING_PERSISTENT == 'false' && env.SKIP_CLEANUP == 'false'
        timeout-minutes: 5
        run: |
          echo "ðŸ§¹ Cleaning up ephemeral instance..."
          docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v --remove-orphans || true
          rm -rf ${{ env.LOGS_DIR }}
          echo "âœ… Cleanup complete"
      
      # =====================================================================
      # STEP 11: Summary
      # =====================================================================
      - name: ðŸ“ Workflow Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Mode** | ${{ steps.mode.outputs.mode }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | $N8N_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| **Passed** | ${{ steps.parse.outputs.PASSED }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Failed** | ${{ steps.parse.outputs.FAILED }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Success Rate** | ${{ steps.parse.outputs.SUCCESS_RATE }}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.mode.outputs.mode }}" == "persistent" ]; then
            echo "âœ… **Persistent mode**: Using existing n8n instance" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”µ **Ephemeral mode**: Created temporary instance" >> $GITHUB_STEP_SUMMARY
          fi