name: ğŸš¨ Emergency Deployment (Manual Only)

# âš ï¸ CRITICAL: Ğ­Ñ‚Ğ¾Ñ‚ workflow Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ Ğ‘Ğ•Ğ— ĞŸĞ ĞĞ’Ğ•Ğ ĞĞš!
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ hotfix Ğ¸ emergency ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¹

on:
  # Ğ¢ĞĞ›Ğ¬ĞšĞ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº - Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ… Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğ¾Ğ²
  workflow_dispatch:
    inputs:
      deployment_reason:
        description: 'ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° emergency Ğ´ĞµĞ¿Ğ»Ğ¾Ñ (Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)'
        required: true
        type: string
      skip_backup:
        description: 'ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ backup (ĞĞ• Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)'
        required: false
        type: boolean
        default: false
      force_restart:
        description: 'Force restart Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²'
        required: false
        type: boolean
        default: false

# ĞĞµ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ emergency Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ² Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
concurrency:
  group: emergency-deployment
  cancel-in-progress: false

env:
  DEPLOY_DIR: /home/artikk/n8n-production
  BACKUP_DIR: /home/artikk/n8n-backups

jobs:
  # âš ï¸ ĞŸĞ Ğ•Ğ”Ğ£ĞŸĞ Ğ•Ğ–Ğ”Ğ•ĞĞ˜Ğ•
  emergency-warning:
    name: âš ï¸ Emergency Deployment Warning
    runs-on: self-hosted
    steps:
      - name: ğŸš¨ Display warning banner
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                               â•‘"
          echo "â•‘               âš ï¸  EMERGENCY DEPLOYMENT MODE âš ï¸                â•‘"
          echo "â•‘                                                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  WARNING: Deploying WITHOUT validation checks!"
          echo ""
          echo "ğŸ”“ BYPASSING:"
          echo "   â€¢ Infrastructure checks"
          echo "   â€¢ n8n validation tests"
          echo "   â€¢ E2E tests"
          echo "   â€¢ Code quality checks"
          echo "   â€¢ Security scans"
          echo ""
          echo "ğŸ“‹ DEPLOYMENT INFO:"
          echo "   â€¢ Reason: ${{ github.event.inputs.deployment_reason }}"
          echo "   â€¢ Triggered by: ${{ github.actor }}"
          echo "   â€¢ Branch: ${{ github.ref }}"
          echo "   â€¢ Commit: ${{ github.sha }}"
          echo "   â€¢ Skip Backup: ${{ github.event.inputs.skip_backup }}"
          echo "   â€¢ Force Restart: ${{ github.event.inputs.force_restart }}"
          echo "   â€¢ Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âš¡ Proceeding with emergency deployment..."
          echo ""

  # ğŸ’¾ BACKUP (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)
  emergency-backup:
    name: ğŸ’¾ Emergency Backup
    runs-on: self-hosted
    needs: emergency-warning
    if: github.event.inputs.skip_backup != 'true'
    steps:
      - name: ğŸ’¾ Create emergency backup
        run: |
          echo "ğŸ’¾ Creating emergency backup..."
          
          mkdir -p ${{ env.BACKUP_DIR }}
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_NAME="emergency-backup-${TIMESTAMP}"
          
          # Backup PostgreSQL
          if docker ps | grep -q postgres; then
            echo "ğŸ“¦ Backing up PostgreSQL..."
            docker exec postgres pg_dump -U n8n n8n > "${{ env.BACKUP_DIR }}/${BACKUP_NAME}.sql"
            gzip "${{ env.BACKUP_DIR }}/${BACKUP_NAME}.sql"
            echo "âœ… Database backup: ${BACKUP_NAME}.sql.gz"
          else
            echo "âš ï¸  PostgreSQL not running - skipping DB backup"
          fi
          
          # Backup .env
          if [ -f "${{ env.DEPLOY_DIR }}/.env" ]; then
            cp "${{ env.DEPLOY_DIR }}/.env" "${{ env.BACKUP_DIR }}/${BACKUP_NAME}.env"
            echo "âœ… .env file backed up"
          fi
          
          # Backup current docker-compose.yml
          if [ -f "${{ env.DEPLOY_DIR }}/docker-compose.yml" ]; then
            cp "${{ env.DEPLOY_DIR }}/docker-compose.yml" "${{ env.BACKUP_DIR }}/${BACKUP_NAME}.docker-compose.yml"
            echo "âœ… docker-compose.yml backed up"
          fi
          
          echo ""
          echo "âœ… Emergency backup completed: ${BACKUP_NAME}"
          echo "Backup location: ${{ env.BACKUP_DIR }}"

  # ğŸš€ EMERGENCY DEPLOYMENT
  emergency-deploy:
    name: ğŸš€ Emergency Deploy to Production
    runs-on: self-hosted
    needs: [emergency-warning, emergency-backup]
    if: always() && needs.emergency-warning.result == 'success'
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6
      
      - name: ğŸ”§ Install dependencies
        run: |
          echo "ğŸ”§ Checking required tools..."
          
          # Check rsync
          if ! command -v rsync &> /dev/null; then
            echo "âš ï¸  rsync not found - installing..."
            sudo apt-get update -qq
            sudo apt-get install -y rsync
            echo "âœ… rsync installed"
          else
            echo "âœ… rsync already installed"
          fi
          
          # Check docker
          if ! command -v docker &> /dev/null; then
            echo "âŒ Docker not found in PATH!"
            exit 1
          else
            echo "âœ… docker command available: $(docker --version)"
          fi
          
          # Check docker-compose
          if ! command -v docker-compose &> /dev/null; then
            echo "âŒ docker-compose not found in PATH!"
            exit 1
          else
            echo "âœ… docker-compose available: $(docker-compose --version)"
          fi
          
          echo "âœ… All dependencies ready"
      
      - name: ğŸ“‹ Log deployment start
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš¨ EMERGENCY DEPLOYMENT STARTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Reason: ${{ github.event.inputs.deployment_reason }}"
          echo "Actor: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date)"
          echo ""
      
      - name: ğŸ“‚ Prepare production directory
        run: |
          echo "ğŸ“‚ Syncing code to production..."
          
          mkdir -p ${{ env.DEPLOY_DIR }}
          
          rsync -av --delete \
            --exclude='.git' \
            --exclude='_work' \
            --exclude='node_modules' \
            --exclude='.env' \
            ./ ${{ env.DEPLOY_DIR }}/
          
          echo "âœ… Code synced"
      
      - name: ğŸ”‘ Create production .env
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "ğŸ”‘ Creating production .env..."
          
          cat > .env << EOF
          # Emergency Deployment Environment
          # Generated: $(date)
          # Reason: ${{ github.event.inputs.deployment_reason }}
          
          # Database
          POSTGRES_DB=n8n
          POSTGRES_USER=n8n
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          
          # Redis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          
          # n8n Configuration
          N8N_HOST=0.0.0.0
          N8N_PORT=5678
          N8N_PROTOCOL=http
          WEBHOOK_URL=http://192.168.0.105:5678/
          
          # n8n Authentication
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          N8N_API_KEY=${{ secrets.N8N_API_KEY }}
          
          # Tor
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          
          # Monitoring
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          
          # Optional API Keys
          FIRECRAWL_API_KEY=
          JINA_API_KEY=
          EOF
          
          chmod 600 .env
          echo "âœ… Production .env created"
      
      - name: ğŸ­ Build production images
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "ğŸ­ Building Docker images (using legacy builder)..."
          
          docker build \
            -t n8n-enhanced:production \
            -t n8n-enhanced:latest \
            -t n8n-enhanced:emergency-$(date +%Y%m%d-%H%M%S) \
            -f Dockerfile.n8n-enhanced \
            .
          
          echo "âœ… Images built"
      
      - name: ğŸ›‘ Stop services
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "ğŸ›‘ Stopping services..."
          
          if [ "${{ github.event.inputs.force_restart }}" = "true" ]; then
            echo "âš¡ Force restart enabled - stopping ALL services"
            docker-compose down
          else
            echo "ğŸ”„ Graceful stop - keeping database running"
            docker-compose stop n8n tor ml-service ollama 2>/dev/null || true
          fi
          
          sleep 5
          echo "âœ… Services stopped"
      
      - name: ğŸ—‘ï¸ Clean old containers (if force restart)
        if: github.event.inputs.force_restart == 'true'
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "ğŸ—‘ï¸ Removing old containers..."
          docker-compose down -v 2>/dev/null || true
          echo "âœ… Cleanup complete"
      
      - name: ğŸš€ Start production services
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "ğŸš€ Starting production services..."
          
          # Start database and Redis
          docker-compose up -d postgres redis
          echo "â³ Waiting for database (15s)..."
          sleep 15
          
          # Start n8n with new image
          docker-compose up -d n8n tor
          echo "âœ… Core services started"
          
          # Start monitoring (non-blocking)
          docker-compose up -d prometheus grafana 2>/dev/null || echo "âš ï¸  Monitoring services unavailable"
          
          echo "âœ… All services started"
      
      - name: â³ Wait for n8n startup
        run: |
          echo "â³ Waiting for n8n to become healthy..."
          
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
              echo "âœ… n8n is healthy!"
              
              # Display service status
              docker-compose -f ${{ env.DEPLOY_DIR }}/docker-compose.yml ps
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            
            if [ $((ATTEMPT % 10)) -eq 0 ]; then
              echo "â³ Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            fi
            
            sleep 2
          done
          
          echo "âŒ n8n failed to start within timeout!"
          echo ""
          echo "ğŸ“‹ Recent logs:"
          docker-compose -f ${{ env.DEPLOY_DIR }}/docker-compose.yml logs --tail=100 n8n
          exit 1
      
      - name: ğŸ§ª Basic health check
        run: |
          echo "ğŸ§ª Running basic health checks..."
          
          CHECKS_PASSED=0
          CHECKS_FAILED=0
          
          # Check n8n
          if curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
            echo "âœ… n8n health check passed"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "âŒ n8n health check failed"
            CHECKS_FAILED=$((CHECKS_FAILED + 1))
          fi
          
          # Check PostgreSQL
          if docker exec postgres pg_isready -U n8n > /dev/null 2>&1; then
            echo "âœ… PostgreSQL check passed"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "âŒ PostgreSQL check failed"
            CHECKS_FAILED=$((CHECKS_FAILED + 1))
          fi
          
          # Check Redis
          if docker exec redis redis-cli ping 2>/dev/null | grep -q PONG; then
            echo "âœ… Redis check passed"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "âŒ Redis check failed"
            CHECKS_FAILED=$((CHECKS_FAILED + 1))
          fi
          
          echo ""
          echo "Health Check Summary: $CHECKS_PASSED passed, $CHECKS_FAILED failed"
          
          if [ $CHECKS_FAILED -gt 1 ]; then
            echo "âš ï¸  Multiple services failed health checks!"
            exit 1
          fi
          
          if [ $CHECKS_FAILED -eq 1 ]; then
            echo "âš ï¸  One service failed - continuing (emergency mode)"
          fi
          
          echo "âœ… Basic health checks acceptable"
      
      - name: ğŸ“‹ Display deployment info
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                               â•‘"
          echo "â•‘            âœ… EMERGENCY DEPLOYMENT SUCCESSFUL âœ…              â•‘"
          echo "â•‘                                                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Deployment Details:"
          echo "   â€¢ Reason: ${{ github.event.inputs.deployment_reason }}"
          echo "   â€¢ Commit: ${{ github.sha }}"
          echo "   â€¢ Branch: ${{ github.ref }}"
          echo "   â€¢ Deployed By: ${{ github.actor }}"
          echo "   â€¢ Deploy Time: $(date)"
          echo ""
          echo "ğŸ”— Access URLs:"
          echo "   â€¢ n8n: http://192.168.0.105:5678"
          echo "   â€¢ Grafana: http://192.168.0.105:3001"
          echo "   â€¢ Prometheus: http://192.168.0.105:9090"
          echo ""
          echo "ğŸ“Š Service Status:"
          docker-compose -f ${{ env.DEPLOY_DIR }}/docker-compose.yml ps
          echo ""
          echo "âš ï¸  IMPORTANT: Run full validation when possible!"
          echo ""
      
      - name: ğŸš¨ Rollback on failure
        if: failure()
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                               â•‘"
          echo "â•‘               âŒ EMERGENCY DEPLOYMENT FAILED âŒ               â•‘"
          echo "â•‘                                                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸš¨ Attempting emergency rollback..."
          
          # Stop broken services
          docker-compose down n8n tor
          
          # Try to restart with old image
          docker-compose up -d n8n tor
          
          echo ""
          echo "ğŸ“‹ Post-rollback logs:"
          docker-compose logs --tail=100 n8n
          echo ""
          echo "âš ï¸  Manual intervention may be required!"
          echo ""
          echo "ğŸ” Check backup location: ${{ env.BACKUP_DIR }}"
          echo "ğŸ” Check logs: docker-compose logs n8n"

  # ğŸ“Š DEPLOYMENT SUMMARY
  emergency-summary:
    name: ğŸ“Š Emergency Deployment Summary
    runs-on: self-hosted
    needs: [emergency-warning, emergency-backup, emergency-deploy]
    if: always()
    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š EMERGENCY DEPLOYMENT SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Deployment Status: ${{ needs.emergency-deploy.result }}"
          echo "Backup Status: ${{ needs.emergency-backup.result }}"
          echo ""
          echo "ğŸ“‹ Details:"
          echo "   â€¢ Reason: ${{ github.event.inputs.deployment_reason }}"
          echo "   â€¢ Triggered by: ${{ github.actor }}"
          echo "   â€¢ Commit: ${{ github.sha }}"
          echo "   â€¢ Branch: ${{ github.ref }}"
          echo "   â€¢ Time: $(date)"
          echo "   â€¢ Skip Backup: ${{ github.event.inputs.skip_backup }}"
          echo "   â€¢ Force Restart: ${{ github.event.inputs.force_restart }}"
          echo ""
          
          if [ "${{ needs.emergency-deploy.result }}" = "success" ]; then
            echo "âœ… Emergency deployment completed successfully!"
            echo ""
            echo "ğŸ” Next Steps:"
            echo "   1. Verify n8n: http://192.168.0.105:5678"
            echo "   2. Check logs: docker-compose logs -f n8n"
            echo "   3. Monitor metrics: http://192.168.0.105:3001"
            echo "   4. Run full validation when possible"
            echo ""
            echo "ğŸ“ Backup location: ${{ env.BACKUP_DIR }}"
          else
            echo "âŒ Emergency deployment FAILED!"
            echo ""
            echo "ğŸ” Troubleshooting:"
            echo "   1. Check n8n logs: docker-compose logs n8n"
            echo "   2. Check service status: docker-compose ps"
            echo "   3. Review backup: ls -lh ${{ env.BACKUP_DIR }}"
            echo "   4. Manual recovery may be required"
            echo ""
            echo "ğŸ“ Contact: ${{ github.actor }}"
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
