name: Security Scan

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  trivy-fs-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e  # v6.pre.beta

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'  # Don't fail build, just report

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@f94c9befffa4412c356fb5463a959ab7821dd57e  # v3.25.1
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

  trivy-docker-scan:
    name: Trivy Docker Image Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - redis:7-alpine
          - postgres:16-alpine
          - prom/prometheus:latest
          - grafana/grafana:latest
          - n8nio/n8n:latest
    steps:
      - name: Run Trivy vulnerability scanner (Docker image)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          scan-type: 'image'
          image-ref: ${{ matrix.image }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail if critical/high vulns found

  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e  # v6.pre.beta

      - name: Setup Node.js
        uses: actions/setup-node@dda4788290998366da86b6a4f497909644397bb2  # v4.0.2
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run npm audit (production only)
        run: npm audit --production --audit-level=high

  pip-audit:
    name: Python Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e  # v6.pre.beta

      - name: Setup Python
        uses: actions/setup-python@97aeb3efb8a852c559869050c7fb175b4efcc8cf  # v5.0.0
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: pip-audit --requirement requirements.txt --format json --output pip-audit-results.json
        continue-on-error: true

      - name: Upload pip-audit results
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        if: always()
        with:
          name: pip-audit-results
          path: pip-audit-results.json

  secret-scan:
    name: Secret Scanning (GitLeaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e  # v6.pre.beta
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@1f2d10fb689bc07a5f56f0c32f97a825e6835463  # v2.3.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [trivy-fs-scan, npm-audit, pip-audit, secret-scan]
    if: always()
    steps:
      - name: Post security summary
        run: |
          echo "## Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Trivy Filesystem Scan" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ NPM Audit" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Python pip-audit" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Secret Scanning (GitLeaks)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review detailed results in GitHub Security tab." >> $GITHUB_STEP_SUMMARY
