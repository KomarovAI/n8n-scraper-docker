name: Security Scan

# ðŸ”’ SECURITY: Manual triggers only
# Schedule removed - run manually or via CLI when needed
on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - trivy-fs
          - trivy-docker
          - npm-audit
          - pip-audit
          - secrets

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  trivy-fs-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'trivy-fs'
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e  # v6.pre.beta

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@f94c9befffa4412c356fb5463a959ab7821dd57e  # v3.25.1
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

  trivy-docker-scan:
    name: Trivy Docker Image Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'trivy-docker'
    strategy:
      matrix:
        image:
          - redis:7-alpine
          - postgres:16-alpine
          - n8nio/n8n:latest
    steps:
      - name: Run Trivy vulnerability scanner (Docker image)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          scan-type: 'image'
          image-ref: ${{ matrix.image }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'npm-audit'
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e  # v6.pre.beta

      - name: Setup Node.js
        uses: actions/setup-node@dda4788290998366da86b6a4f497909644397bb2  # v4.0.2
        with:
          node-version: '18'

      - name: Run npm audit
        run: |
          echo "NPM audit placeholder - no package.json in this repo"
          echo "Skipping npm audit"

  pip-audit:
    name: Python Security Audit
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'pip-audit'
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e  # v6.pre.beta

      - name: Setup Python
        uses: actions/setup-python@97aeb3efb8a852c559869050c7fb175b4efcc8cf  # v5.0.0
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit placeholder
        run: |
          echo "Python audit placeholder - dependencies in Docker image"
          echo "Run security scans on built images instead"

  secret-scan:
    name: Secret Scanning (GitLeaks)
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'secrets'
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e  # v6.pre.beta
        with:
          fetch-depth: 0

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@1f2d10fb689bc07a5f56f0c32f97a825e6835463  # v2.3.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [trivy-fs-scan, npm-audit, pip-audit, secret-scan]
    if: always()
    steps:
      - name: Post security summary
        run: |
          echo "## Security Scan Complete (Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan type: ${{ github.event.inputs.scan_type }}" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review detailed results in GitHub Security tab." >> $GITHUB_STEP_SUMMARY
