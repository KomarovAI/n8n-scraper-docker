name: 3 Full E2E Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  workflow_call:

concurrency:
  group: e2e-testing-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  e2e-tests:
    name: E2E Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image (fast cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.n8n-enhanced
          tags: n8n-enhanced:test
          load: true
          cache-from: |
            type=gha,scope=buildkit-n8n-${{ github.ref_name }}
            type=gha,scope=buildkit-n8n-main
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start stack
        run: |
          docker compose up -d postgres redis
          sleep 8
          docker compose up -d n8n
      
      - name: Wait for n8n
        run: |
          START=$(date +%s)
          for i in {1..60}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || curl -sf http://localhost:5678 > /dev/null 2>&1; then
              exit 0
            fi
            sleep 1
          done
          docker compose logs --tail=50 n8n
          exit 1
      
      - name: Run test
        id: test
        run: |
          if [ -f "tests/e2e/workflow-test.js" ]; then
            node tests/e2e/workflow-test.js 2>&1 | tee /tmp/e2e-test.log
          else
            echo "No E2E test file found - skipping" | tee /tmp/e2e-test.log
          fi
        continue-on-error: true
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cp /tmp/e2e-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/e2e-test.log
          docker compose logs n8n > /tmp/logs/e2e-n8n.log 2>&1 || true
          jq -n --arg job "e2e" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/e2e-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-logs-test
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  ml-services:
    name: ML Services
    runs-on: ubuntu-latest
    timeout-minutes: 12
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: "Ollama", slug: "ollama", services: "ollama", timeout: 600 }
          - { name: "ML Service", slug: "ml-service", services: "ollama redis ml-service", timeout: 600 }
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image (fast cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.n8n-enhanced
          tags: n8n-enhanced:test
          load: true
          cache-from: |
            type=gha,scope=buildkit-n8n-${{ github.ref_name }}
            type=gha,scope=buildkit-n8n-main
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start ML services
        run: docker compose up -d ${{ matrix.test.services }}
      
      - name: Wait for services
        run: |
          START=$(date +%s)
          MAX_WAIT=${{ matrix.test.timeout }}
          while [ $(($(date +%s) - START)) -lt $MAX_WAIT ]; do
            [ "${{ matrix.test.slug }}" = "ollama" ] && curl -sf http://localhost:11434/api/tags > /dev/null 2>&1 && exit 0
            [ "${{ matrix.test.slug }}" = "ml-service" ] && curl -sf http://localhost:8000/health > /dev/null 2>&1 && exit 0
            sleep 2
          done
          docker compose logs --tail=100
          exit 1
      
      - name: Test ML endpoint
        id: test
        if: matrix.test.slug == 'ml-service'
        run: curl -v http://localhost:8000/health | tee /tmp/ml-${{ matrix.test.slug }}-test.log
        continue-on-error: true
      
      - name: Save metrics
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          cp /tmp/ml-${{ matrix.test.slug }}-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/ml-${{ matrix.test.slug }}-test.log
          docker compose logs ${{ matrix.test.services }} > /tmp/logs/ml-${{ matrix.test.slug }}-container.log 2>&1 || true
          jq -n --arg job "ml-${{ matrix.test.slug }}" --arg test_name "${{ matrix.test.name }}" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, test_name: $test_name, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/ml-${{ matrix.test.slug }}-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-logs-ml-${{ matrix.test.slug }}
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  n8n-integration:
    name: Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image (fast cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.n8n-enhanced
          tags: n8n-enhanced:test
          load: true
          cache-from: |
            type=gha,scope=buildkit-n8n-${{ github.ref_name }}
            type=gha,scope=buildkit-n8n-main
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start n8n
        run: |
          docker compose up -d postgres redis
          sleep 8
          docker compose up -d n8n
      
      - name: Verify n8n
        run: |
          START=$(date +%s)
          for i in {1..60}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || curl -sf http://localhost:5678 > /dev/null 2>&1; then
              exit 0
            fi
            sleep 1
          done
          docker compose logs --tail=50 n8n
          exit 1
      
      - name: Run test
        id: test
        run: |
          if [ -f "tests/n8n/test_workflows.sh" ]; then
            chmod +x tests/n8n/test_workflows.sh
            bash tests/n8n/test_workflows.sh 2>&1 | tee /tmp/integration-test.log
          else
            echo "No integration test - skipping" | tee /tmp/integration-test.log
          fi
        continue-on-error: true
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cp /tmp/integration-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/integration-test.log
          docker compose logs n8n > /tmp/logs/integration-n8n.log 2>&1 || true
          jq -n --arg job "integration" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/integration-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-logs-integration
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  master-e2e:
    name: Master E2E
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [e2e-tests, ml-services, n8n-integration]
    outputs:
      duration: ${{ steps.save.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image (fast cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.n8n-enhanced
          tags: n8n-enhanced:test
          load: true
          cache-from: |
            type=gha,scope=buildkit-n8n-${{ github.ref_name }}
            type=gha,scope=buildkit-n8n-main
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_CI }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_CI }}
          N8N_USER=${{ secrets.N8N_USER_CI }}
          N8N_PASSWORD=${{ secrets.N8N_PASSWORD_CI }}
          TOR_CONTROL_PASSWORD=${{ secrets.TOR_CONTROL_PASSWORD_CI }}
          GRAFANA_USER=${{ secrets.GRAFANA_USER_CI }}
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD_CI }}
          EOF
      
      - name: Start full stack
        run: |
          docker compose up -d postgres redis
          sleep 12
          docker compose up -d n8n
          sleep 8
          docker compose up -d tor prometheus grafana
      
      - name: Wait for services
        run: |
          START=$(date +%s)
          for i in {1..90}; do
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1 || curl -sf http://localhost:5678 > /dev/null 2>&1; then
              break
            fi
            sleep 1
          done
          sleep 10
          docker compose ps
      
      - name: Run MASTER TEST
        id: test
        run: |
          chmod +x tests/master/test_full_e2e.sh
          bash tests/master/test_full_e2e.sh 2>&1 | tee /tmp/master-test.log
        continue-on-error: true
      
      - name: Save metrics
        id: save
        if: always()
        run: |
          mkdir -p /tmp/logs
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cp /tmp/master-test.log /tmp/logs/ 2>/dev/null || echo "No output" > /tmp/logs/master-test.log
          docker compose logs --tail=100 n8n > /tmp/logs/master-n8n.log 2>&1
          jq -n --arg job "master" --arg status "${{ job.status }}" --argjson start "$START_TIME" --argjson end "$END_TIME" --argjson duration "$DURATION" --arg exit_code "${{ steps.test.outcome }}" '{job: $job, status: $status, start_time: $start, end_time: $end, duration_seconds: $duration, exit_code: $exit_code}' > /tmp/logs/master-metrics.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-logs-master
          path: /tmp/logs/
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          [ ! -f .env ] && touch .env
          docker compose down -v

  summary:
    name: E2E Testing Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, ml-services, n8n-integration, master-e2e]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Download logs
        uses: actions/download-artifact@v6
        with:
          pattern: e2e-logs-*
          path: all-logs/
          merge-multiple: true
        continue-on-error: true
      
      - name: Generate summary
        run: |
          mkdir -p logs
          [ -d "all-logs" ] && find all-logs -type f -exec cp {} logs/ \;
          
          PASSED=0
          FAILED=0
          [ "${{ needs.e2e-tests.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.ml-services.result }}" == "success" ] && PASSED=$((PASSED + 2)) || FAILED=$((FAILED + 2))
          [ "${{ needs.n8n-integration.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          [ "${{ needs.master-e2e.result }}" == "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          
          SUCCESS_RATE=$((PASSED * 100 / 5))
          TOTAL_DURATION=$((${{ needs.e2e-tests.outputs.duration }} + ${{ needs.n8n-integration.outputs.duration }} + ${{ needs.master-e2e.outputs.duration }}))
          
          cat > logs/e2e-summary.md << EOF
          # Full E2E Testing Summary
          
          **E2E Tests**: ${{ needs.e2e-tests.result }}
          **ML Services**: ${{ needs.ml-services.result }}
          **Integration**: ${{ needs.n8n-integration.result }}
          **Master E2E**: ${{ needs.master-e2e.result }}
          
          **Stats**: ${PASSED} passed, ${FAILED} failed, ${SUCCESS_RATE}%
          **Total Duration**: ${TOTAL_DURATION}s
          EOF
          
          cat logs/e2e-summary.md
          
          jq -n --argjson p "$PASSED" --argjson f "$FAILED" --argjson d "$TOTAL_DURATION" --argjson r "${{ github.run_number }}" --arg s "${{ github.sha }}" '{summary:{tests:5,passed:$p,failed:$f,duration:($d*1000)},environment:{workflow_run:$r,workflow_sha:$s}}' > logs/e2e-report.json
      
      - name: Upload summary
        uses: actions/upload-artifact@v5
        with:
          name: full-e2e-testing-summary
          path: logs/
          retention-days: 7
        if: always()
      
      - name: Cleanup temp logs
        uses: geekyeggo/delete-artifact@v5
        with:
          name: e2e-logs-*
          failOnError: false
        if: always()
