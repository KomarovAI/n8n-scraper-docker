# ==========================================
# Docker Compose Override for CI/CD
# ==========================================
# Этот файл переопределяет настройки docker-compose.yml
# для использования в CI/CD окружении.
#
# Использование:
#   docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d
#
# Цель:
#   - CI использует кастомный n8n-enhanced:test
#   - Production использует n8nio/n8n:latest
#   - Чистое разделение CI/Production конфигов
# ==========================================

services:
  postgres:
    image: postgres:16-alpine
    container_name: n8n-postgres
    environment:
      POSTGRES_DB: scraper_db
      POSTGRES_USER: scraper_user
      POSTGRES_PASSWORD: test_password_postgres_123
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scraper_user"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s  # Увеличено с 20s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: n8n-redis
    command: redis-server --appendonly yes --requirepass test_password_redis_123
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "test_password_redis_123", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # n8n: CI override для использования кастомного образа
  n8n:
    # Переопределение образа:
    # - Production (docker-compose.yml): n8nio/n8n:latest
    # - CI (docker-compose.ci.yml): n8n-enhanced:test
    # 
    # Причина: CI собирает кастомный образ с дополнительными скриптами,
    # но docker-compose.yml не должен зависеть от CI логики.
    image: n8n-enhanced:test
    container_name: n8n-app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "5678:5678"
    environment:
      # ==========================================
      # n8n 1.x USER MANAGEMENT (НЕ Basic Auth!)
      # ==========================================
      # ВАЖНО: n8n 1.0+ удалил Basic Auth полностью!
      # 
      # Официальная документация:
      # https://docs.n8n.io/1-0-migration-checklist/
      # "полностью удалена поддержка Basic Auth"
      # 
      # Аутентификация в n8n 1.121.3:
      #   1. POST /rest/owner/setup - создание owner account
      #   2. Cookie: n8n-auth - session аутентификация
      #   3. POST /rest/login - альтернативный вход
      # 
      # N8N_BASIC_AUTH_* переменные НЕ ИСПОЛЬЗУЮТСЯ!
      # Они полностью игнорируются n8n >= 1.0
      # ==========================================
      
      # Database настройки
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: scraper_db
      DB_POSTGRESDB_USER: scraper_user
      DB_POSTGRESDB_PASSWORD: test_password_postgres_123
      
      # n8n настройки
      N8N_METRICS: "true"
      N8N_DIAGNOSTICS_ENABLED: "false"
      EXECUTIONS_DATA_SAVE_ON_ERROR: all
      EXECUTIONS_DATA_SAVE_ON_SUCCESS: all
      EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS: "true"
      
      # ✅ NEW: Static encryption key for CI API key persistence
      # This ensures API keys work across container restarts in CI
      # WARNING: Only for CI! Use random key in production!
      N8N_ENCRYPTION_KEY: "ci-static-encryption-key-for-testing-only-12345678-do-not-use-in-production"
      
      # CI-специфичное логирование
      N8N_LOG_LEVEL: debug
      N8N_LOG_OUTPUT: console
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 15s
      timeout: 10s
      retries: 10  # Увеличено с 6
      start_period: 180s  # Увеличено с 120s (миграции БД + auth)
    restart: unless-stopped

networks:
  default:
    driver: bridge